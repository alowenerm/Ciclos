<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>** Brick Wise **</title>
    
    <link rel="icon" type="image/png" href="https://alowenerm.github.io/Ciclos/brickwise-ft.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons for Excel & Save Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- noUiSlider for range sliders -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf-autotable.umd.min.js"></script>
    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>


    <style>
        body { background-color: #f8f9fa; }
        .card { box-shadow: 0 2px 4px rgba(0,0,0,.1); }
        .card .table-responsive { max-height: 500px; }
        .kpi-card { text-align: center; padding: 1rem; border: 1px solid #dee2e6; border-radius: .375rem; background-color: #fff; }
        .kpi-value { font-size: 1.5rem; font-weight: bold; }
        .kpi-label { font-size: 0.9rem; color: #6c757d; }
        .kpi-card.positive .kpi-value, .header-kpi.positive .header-kpi-value { color: #198754; }
        .kpi-card.negative .kpi-value, .header-kpi.negative .header-kpi-value { color: #dc3545; }
        tfoot { font-weight: bold; background-color: #f8f9fa; }
        /* Forzar alineación a la derecha para todos los inputs numéricos controlados */
        input[data-format="number"], .text-center, .text-end { text-align: right; }
        .text-center-input, .text-center-input input, .text-center { text-align: center; }
        .calculated-field { background-color: #e9ecef; padding: 0.375rem 0.75rem; border-radius: 0.375rem; border: 1px solid #ced4da; text-align: right;}
        .header-kpi { text-align: center; padding: 0.3rem 0.6rem; border: 1px solid #dee2e6; border-radius: .375rem; background-color: #fff; flex: 1; }
        .header-kpi-value { font-size: 1.1rem; font-weight: bold; }
        .header-kpi-label { font-size: 0.75rem; color: #6c757d; text-transform: uppercase; }

        /* Tab Styling */
        .nav-tabs {
            border-bottom: 1px solid #dee2e6;
        }
        .nav-tabs .nav-link {
            color: #495057;
            border: 1px solid transparent; /* Make border transparent to align with active tab */
            border-bottom: none;
            margin-bottom: -1px;
        }
        .nav-tabs .nav-link:not(.active) {
            background-color: transparent;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            color: #000;
            background-color: #fff;
            border-color: #dee2e6 #dee2e6 #fff;
        }
        .nav-tabs .nav-link i {
            margin-right: 0.3rem;
        }

        /* Estilos para la tabla de Flujo de Caja (columnas congeladas) */
        .cashflow-table th, .cashflow-table td {
            min-width: 110px;
            white-space: nowrap;
        }
        .cashflow-table thead.sticky-top th {
            z-index: 3;
        }
        .cashflow-table th:first-child, .cashflow-table td:first-child {
            position: sticky;
            left: 0;
            z-index: 2;
            width: 230px; 
            min-width: 230px;
        }
        .cashflow-table thead.sticky-top th:first-child {
            z-index: 4;
        }
        .cashflow-table th:nth-child(2), .cashflow-table td:nth-child(2) {
            position: sticky;
            left: 230px; /* Debe coincidir con el ancho de la primera columna */
            z-index: 2;
            width: 120px;
            min-width: 120px;
        }
        .cashflow-table thead.sticky-top th:nth-child(2) {
            z-index: 4;
        }
        /* Fondos para que no se vea el contenido al hacer scroll */
        .cashflow-table .table-dark th {
             background-color: var(--bs-dark) !important;
        }
        .cashflow-table td:first-child, 
        .cashflow-table td:nth-child(2) {
             background-color: var(--bs-table-bg);
        }
        .table-striped > tbody > tr:nth-of-type(odd) > td:first-child,
        .table-striped > tbody > tr:nth-of-type(odd) > td:nth-child(2) {
             background-color: #f8f9fa; /* Color gris claro sólido para evitar transparencias */
        }
        .bg-light.fw-bold.text-start td {
            background-color: var(--bs-light) !important;
        }
        #curvaSGraph {
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
        }
        
        /* noUiSlider Custom Styles - Simple & Professional */
        .timeline-control .noUi-target {
            background: #e9ecef;
            border-radius: 4px;
            border: none;
            box-shadow: none;
            height: 4px;
        }
        .timeline-control .noUi-connect {
            background: #adb5bd;
        }
        .timeline-control .noUi-handle {
            background: #adb5bd; /* Match connect color */
            border: none;
            border-radius: 50%;
            box-shadow: none;
            cursor: pointer;
            width: 14px;   /* Smaller handle */
            height: 14px;  /* Smaller handle */
            right: -7px;   /* Adjusted position */
            top: -5px;     /* Adjusted position */
        }
        .timeline-control .noUi-handle::before, .timeline-control .noUi-handle::after {
            display: none;
        }
        .timeline-control .noUi-handle:focus {
            outline: none;
        }
        .timeline-control-inputs { 
            display: flex; 
            justify-content: space-between; 
            gap: 10px; 
        }
        .timeline-control-inputs input { 
            max-width: 80px; 
            text-align: center; 
            font-size: 0.75rem; /* Smaller font */
        }
        .single-slider-input {
            max-width: 100px !important;
            margin: 0 auto;
        }
        .section-header {
            background-color: #f8f9fa;
            padding: 0.5rem 1rem;
            margin: 1.5rem -1rem 1rem -1rem;
            border-top: 1px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
            font-size: 0.9rem;
        }
        /* START: Style for the new sticky header */
        #app-header {
            background-color: rgba(248, 249, 250, 0.95); /* Match body background with slight transparency for effect */
            backdrop-filter: blur(5px);
            padding: 1rem 0;
            z-index: 1030;            /* High z-index to stay on top */
        }
        /* END: Style for the new sticky header */
        
        /* START: Styles for Drag and Drop */
        .drag-handle {
            cursor: move;
            text-align: center;
            vertical-align: middle;
            width: 30px; /* Ancho fijo para el handle */
            min-width: 30px;
        }
        .sortable-ghost {
            opacity: 0.4;
            background-color: #c8ebfb; /* Un azul claro para el feedback visual */
        }
        .sortable-drag {
            background-color: #e9f5fe; /* Un color de fondo ligero para la fila que se está arrastrando */
        }
        /* END: Styles for Drag and Drop */

        /* START: Styles for "Grafico" Tab */
        #cashflow-checklist-container {
            max-height: 70vh; /* Adjust as needed */
            overflow-y: auto;
        }
        .cashflow-checklist .list-group-item {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        .cashflow-checklist .form-check {
            margin-bottom: 0;
        }
        .cashflow-checklist .form-check-label {
            font-size: 0.9rem;
        }
        .cashflow-checklist .item-total {
            font-size: 0.85rem;
            color: #6c757d;
        }
        /* Style for grey checkboxes */
        .cashflow-checklist .form-check-input {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }
        .cashflow-checklist .form-check-input:checked {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        .cashflow-checklist .form-check-input:focus {
            box-shadow: 0 0 0 0.25rem rgba(108, 117, 125, 0.25);
        }
        /* END: Styles for "Grafico" Tab */

    </style>
</head>
<body>

    <div class="container mb-5">
        <!-- START: New wrapper for sticky header -->
        <div id="app-header" class="sticky-top">
            <!-- Top bar for Logo, Tabs, and Actions -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center gap-4">
                    <img src="https://alowenerm.github.io/Ciclos/brickwise-ft.png" alt="Logo" style="height: 60px;">
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation"><button class="nav-link active" id="params-tab-btn" data-bs-toggle="tab" data-bs-target="#params" type="button" role="tab"><i class="bi bi-sliders"></i>Parámetros</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" id="eval-tab-btn" data-bs-toggle="tab" data-bs-target="#eval" type="button" role="tab"><i class="bi bi-graph-up"></i>Evaluación</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" id="flow-tab-btn" data-bs-toggle="tab" data-bs-target="#flow" type="button" role="tab"><i class="bi bi-table"></i>Flujo de Caja</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" id="resumen-tab-btn" data-bs-toggle="tab" data-bs-target="#resumen" type="button" role="tab"><i class="bi bi-file-earmark-text"></i>Resumen</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" id="grafico-tab-btn" data-bs-toggle="tab" data-bs-target="#grafico" type="button" role="tab"><i class="bi bi-bar-chart-line"></i>Gráfico</button></li>
                    </ul>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <!-- Input oculto para la importación -->
                    <input type="file" id="import-file-input" accept=".json" style="display: none;">
                    
                    <!-- START: Undo/Redo Buttons -->
                    <button id="undo-btn" class="btn btn-outline-secondary btn-sm" title="Deshacer (Ctrl+Z)" disabled>
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                    <button id="redo-btn" class="btn btn-outline-secondary btn-sm" title="Rehacer (Ctrl+Y)" disabled>
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <!-- END: Undo/Redo Buttons -->
                    
                    <label for="import-file-input" id="import-model-btn" class="btn btn-outline-secondary btn-sm mb-0">
                        <i class="bi bi-upload"></i> Importar
                    </label>
                    <button id="export-model-btn" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-download"></i> Exportar
                    </button>
                    <button id="save-model-btn" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-save"></i> Informes
                    </button>
                    <button id="copy-active-tab-btn" class="btn btn-outline-secondary btn-sm" title="Copiar todos los parámetros de entrada al portapapeles">
                        <i class="bi bi-clipboard"></i> Copiar
                    </button>
                </div>
            </div>
            <!-- KPI Container -->
            <div id="header-kpi-container" class="d-flex flex-column gap-2">
                <div class="d-flex gap-2 justify-content-between">
                    <!-- Fila 1 de KPIs -->
                    <div id="header-kpi-inversion" class="header-kpi"><div class="header-kpi-label">INVERSIÓN</div><div class="header-kpi-value">--</div></div>
                    <div id="header-kpi-aportes" class="header-kpi"><div class="header-kpi-label">APORTES</div><div class="header-kpi-value">--</div></div>
                    <div id="header-kpi-utilidad" class="header-kpi"><div class="header-kpi-label">UTILIDAD</div><div class="header-kpi-value">--</div></div>
                    <div id="header-kpi-tir" class="header-kpi"><div class="header-kpi-label">TIR</div><div class="header-kpi-value">--</div></div>
                    <div id="header-kpi-roi" class="header-kpi"><div class="header-kpi-label">ROI</div><div class="header-kpi-value">--</div></div>
                    <div id="header-kpi-venta" class="header-kpi"><div class="header-kpi-label">VENTA</div><div class="header-kpi-value">--</div></div>
                    <div id="header-kpi-unidades" class="header-kpi"><div class="header-kpi-label">UNIDADES</div><div class="header-kpi-value">--</div></div>
                    <div id="header-kpi-sup-venta" class="header-kpi"><div class="header-kpi-label">SUP VENTA</div><div class="header-kpi-value">--</div></div>
                </div>
                <div class="d-flex gap-2 justify-content-between">
                    <!-- Fila 2 de KPIs -->
                    <div id="header-kpi-deuda" class="header-kpi"><div class="header-kpi-label">DEUDA</div><div class="header-kpi-value">--</div></div>
                    <div id="header-kpi-costos-deuda" class="header-kpi"><div class="header-kpi-label">COSTOS-DEUDA</div><div class="header-kpi-value">--</div></div>
                    <div id="header-kpi-intereses" class="header-kpi"><div class="header-kpi-label">INTERESES</div><div class="header-kpi-value">--</div></div>
                    <div id="header-kpi-van" class="header-kpi"><div class="header-kpi-label">VAN</div><div class="header-kpi-value">--</div></div>
                    <div id="header-kpi-ros" class="header-kpi"><div class="header-kpi-label">ROS</div><div class="header-kpi-value">--</div></div>
                    <div id="header-kpi-costo-constr" class="header-kpi"><div class="header-kpi-label">COSTO CONSTR.</div><div class="header-kpi-value">--</div></div>
                    <div id="header-kpi-estac" class="header-kpi"><div class="header-kpi-label">ESTAC</div><div class="header-kpi-value">--</div></div>
                    <div id="header-kpi-sup-constr" class="header-kpi"><div class="header-kpi-label">SUP CONSTR.</div><div class="header-kpi-value">--</div></div>
                </div>
            </div>
        </div>
        <!-- END: New wrapper for sticky header -->

        <!-- Contenido de las Pestañas -->
        <div class="tab-content" id="myTabContent">
            <!-- PESTAÑA 1: PARÁMETROS -->
            <div class="tab-pane fade show active p-4 border rounded" id="params" role="tabpanel" aria-labelledby="params-tab-btn">
                
                <div class="row g-4">
                    <!-- Columna Izquierda -->
                    <div class="col-lg-4">
                        <div class="card mb-4">
                            <div class="card-header fw-bold">Configuración General del Proyecto</div>
                            <div class="card-body">
                                <div class="mb-3"><label for="projectName" class="form-label">Nombre del Proyecto</label><input type="text" class="form-control" id="projectName" value="Edificio Ciclos"></div>
                                <div class="mb-3"><label for="mesInicioVenta" class="form-label">Mes inicio venta</label><input type="number" class="form-control text-center" id="mesInicioVenta" value="5" min="1"></div>
                                <div class="mb-3"><label for="currency" class="form-label">Moneda</label><select class="form-select" id="currency"><option value="UF">UF</option><option value="CLP">CLP</option><option value="USD">USD</option></select></div>
                                <div class="mb-3"><label for="discountRate" class="form-label">Tasa Descuento Anual (%)</label><input type="text" class="form-control" data-format="number" data-decimals="2" id="discountRate" value="10,00" data-allow-formula="true"></div>
                                <div class="mb-3"><label for="taxRate" class="form-label">Tasa Impuesto (%)</label><input type="text" class="form-control" data-format="number" data-decimals="2" id="taxRate" value="27,00" data-allow-formula="true"></div>
                                <div class="mb-3"><label for="iva" class="form-label">IVA (%)</label><input type="text" class="form-control" data-format="number" data-decimals="2" id="iva" value="19,00" data-allow-formula="true"></div>
                                <div class="mb-3"><label for="fechaInicio" class="form-label">Fecha inicio</label><input type="date" class="form-control" id="fechaInicio"></div>
                            </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                                <span>Crédito de construcción</span>
                                <span id="header-total-intereses" class="badge bg-secondary rounded-pill"></span>
                            </div>
                            <div class="card-body">
                                <div class="mb-3"><label for="montoFinanciamiento" class="form-label">Monto (<span data-unit="currency"></span>)</label><input type="text" class="form-control" data-format="number" id="montoFinanciamiento" value="118.000" data-allow-formula="true"></div>
                                <div class="mb-3"><label for="tasaInteresAnual" class="form-label">Tasa interés anual (%)</label><input type="text" class="form-control" data-format="number" data-decimals="2" id="tasaInteresAnual" value="5,00" data-allow-formula="true"></div>
                                <div class="mb-3"><label for="cuotaAlzamiento" class="form-label">Cuota Alzamiento (% ing.)</label><input type="text" class="form-control" data-format="number" data-decimals="0" id="cuotaAlzamiento" value="90" data-allow-formula="true"></div>
                            </div>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                                <span>Deuda</span>
                                <span id="header-total-deuda" class="badge bg-secondary rounded-pill"></span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive" style="max-height: 250px;">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th style="min-width: 120px;">Ítem</th>
                                                <th style="min-width: 110px;">Monto (<span data-unit="currency"></span>)</th>
                                                <th style="min-width: 80px;">Tasa (%)</th>
                                                <th style="min-width: 80px;">Inicio Giros</th>
                                                <th style="min-width: 80px;">Fin Giros</th>
                                                <th style="min-width: 80px;">Inicio Abonos</th>
                                                <th style="min-width: 80px;">Fin Abonos</th>
                                                <th style="min-width: 120px;">Pago</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody id="deuda-tbody"></tbody>
                                    </table>
                                </div>
                                <button id="add-deuda" class="btn btn-sm btn-outline-primary mt-2">+ Agregar Deuda</button>
                            </div>
                        </div>


                        <div class="card mb-4">
                            <div class="card-header fw-bold">Impuestos</div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Renta (<span data-unit="currency"></span>)</label>
                                    <div class="calculated-field" id="calculated-renta">--</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">IVA a Pagar (<span data-unit="currency"></span>)</label>
                                    <div class="calculated-field" id="calculated-iva">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Columna Derecha -->
                    <div class="col-lg-8">
                        <div class="card mb-4">
                            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                                <span>Unidades a Vender (Ingresos)</span>
                                <span id="header-total-ventas" class="badge bg-success rounded-pill"></span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead><tr><th style="width: 30px;"><i class="bi bi-arrows-move"></i></th><th style="width: 120px;">Tipo</th><th>Modelo</th><th class="text-center">Cant.</th><th>Sup. (m²)</th><th>Precio (<span data-unit="currency"></span>)</th><th class="text-center">Tot Vta (<span data-unit="currency"></span>)</th><th class="text-center">Vel Vta (Un/mes)</th><th></th></tr></thead>
                                        <tbody id="unidades-tbody"></tbody>
                                        <tfoot>
                                            <tr><td colspan="7" class="text-end">Total Departamentos:</td><td id="total-deptos">0</td><td></td></tr>
                                            <tr><td colspan="7" class="text-end">Total Casas:</td><td id="total-casas">0</td><td></td></tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <button id="add-unidad" class="btn btn-sm btn-outline-primary mt-2">+ Agregar Unidad</button>
                            </div>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                                <span>Ingresos por Etapas</span>
                                <div class="d-flex align-items-center gap-2">
                                    <span id="header-escrituras-mes" class="badge bg-secondary rounded-pill"></span>
                                    <span id="header-total-ingresos-pct" class="badge bg-secondary rounded-pill"></span>
                                </div>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <thead><tr><th style="width: 30px;"><i class="bi bi-arrows-move"></i></th><th style="width: 20%;">% Ingresos</th><th>Descripción</th><th>Mes Inicio</th><th>Mes Fin</th><th></th></tr></thead>
                                    <tbody id="ingresos-etapas-tbody"></tbody>
                                </table>
                                <button id="add-ingreso-etapa" class="btn btn-sm btn-outline-primary mt-2">+ Agregar Etapa</button>
                            </div>
                        </div>

                        <div class="card mb-4" id="comision-ventas-card-body">
                            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                                <span>Comisión de ventas</span>
                                <span id="header-total-comision" class="badge bg-secondary rounded-pill"></span>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-3"><label for="comisionCierre" class="form-label">% Venta (Cierre)</label><input type="text" class="form-control" data-format="number" data-decimals="2" id="comisionCierre" value="0,50" data-allow-formula="true"></div>
                                    <div class="col-md-4 mb-3"><label for="comisionEscritura" class="form-label">% Venta (Escritura)</label><input type="text" class="form-control" data-format="number" data-decimals="2" id="comisionEscritura" value="1,00" data-allow-formula="true"></div>
                                    <div class="col-md-4 mb-3"><label for="comisionRecuperacion" class="form-label">% Venta (Recup.)</label><input type="text" class="form-control" data-format="number" data-decimals="2" id="comisionRecuperacion" value="0,50" data-allow-formula="true"></div>
                                </div>
                                <div class="row">
                                    <div class="col-12 mb-3"><label class="form-label">% Total Comisión</label><div class="calculated-field" id="totalPorcentajeComision">2,0%</div></div>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-4" id="terreno-card-body">
                             <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                                <span>Terreno</span>
                                <span id="header-total-terreno" class="badge bg-secondary rounded-pill"></span>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3"><label for="precioTerreno" class="form-label">Precio Total (<span data-unit="currency"></span>)</label><input type="text" class="form-control" data-format="number" id="precioTerreno" value="50.000" data-allow-formula="true"></div>
                                    <div class="col-md-6 mb-3"><label for="superficieTerreno" class="form-label">Superficie (m²)</label><input type="text" class="form-control" data-format="number" id="superficieTerreno" value="2.500" data-allow-formula="true"></div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="valorTerrenoM2" class="form-label">Valor</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" data-format="number" data-decimals="2" id="valorTerrenoM2" data-allow-formula="true">
                                            <span class="input-group-text"><span data-unit="currency"></span>/m²</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="mesCompraTerreno" class="form-label">Mes Compra Terreno</label>
                                        <input type="number" class="form-control text-center" id="mesCompraTerreno" value="1" min="1">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                                <span>Construcción</span>
                                <span id="header-total-construccion" class="badge bg-secondary rounded-pill"></span>
                            </div>
                            <div class="card-body" id="construction-card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-3"><label for="superficieLosaSobre" class="form-label">Sobre 0 (m²)</label><input type="text" class="form-control" data-format="number" id="superficieLosaSobre" value="4.500" data-allow-formula="true"></div>
                                    <div class="col-md-4 mb-3"><label for="superficieLosaBajo" class="form-label">Bajo 0 (m²)</label><input type="text" class="form-control" data-format="number" id="superficieLosaBajo" value="1.000" data-allow-formula="true"></div>
                                    <div class="col-md-4 mb-3"><label for="superficieUrbanizacion" class="form-label">Urbanización (m²)</label><input type="text" class="form-control" data-format="number" id="superficieUrbanizacion" value="800" data-allow-formula="true"></div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3"><label for="costoM2Sobre" class="form-label">Costo sobre 0</label><div class="input-group"><input type="text" class="form-control" data-format="number" data-decimals="2" id="costoM2Sobre" value="22,00" data-allow-formula="true"><span class="input-group-text"><span data-unit="currency"></span>/m²</span></div></div>
                                    <div class="col-md-4 mb-3"><label for="costoM2Bajo" class="form-label">Costo bajo 0</label><div class="input-group"><input type="text" class="form-control" data-format="number" data-decimals="2" id="costoM2Bajo" value="15,00" data-allow-formula="true"><span class="input-group-text"><span data-unit="currency"></span>/m²</span></div></div>
                                    <div class="col-md-4 mb-3"><label for="costoM2Urbanizacion" class="form-label">Costo urbanización</label><div class="input-group"><input type="text" class="form-control" data-format="number" data-decimals="2" id="costoM2Urbanizacion" value="5,00" data-allow-formula="true"><span class="input-group-text"><span data-unit="currency"></span>/m²</span></div></div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="ivaAfectoConstruccion" class="form-label">Afecto IVA</label>
                                        <select class="form-select" id="ivaAfectoConstruccion">
                                            <option value="si" selected>Sí</option>
                                            <option value="no">No</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="porcAnticipo" class="form-label">% Anticipo</label>
                                        <input type="text" class="form-control" data-format="number" data-decimals="2" id="porcAnticipo" value="10,00" data-allow-formula="true">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="porcRetencion" class="form-label">% Retención</label>
                                        <input type="text" class="form-control" data-format="number" data-decimals="2" id="porcRetencion" value="5,00" data-allow-formula="true">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3"><label for="mesInicioConstruccion" class="form-label">Mes Inicio</label><input type="number" class="form-control text-center" id="mesInicioConstruccion" value="3" min="1"></div>
                                    <div class="col-md-6 mb-3"><label for="mesTerminoConstruccion" class="form-label">Mes Término</label><input type="number" class="form-control text-center" id="mesTerminoConstruccion" value="20" min="1"></div>
                                </div>
                                <div class="row align-items-center">
                                    <div class="col-12 mb-3">
                                        <label for="curvaSParam" class="form-label">Curva S: <span id="curvaSValue">10</span></label>
                                        <div class="d-flex align-items-center">
                                            <input type="range" class="form-range me-3" id="curvaSParam" min="1" max="20" step="1" value="10">
                                            <canvas id="curvaSGraph" width="80" height="50"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row g-4 mt-0">
                    <div class="col-12">
                        <div class="card mb-4">
                            <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                                <span>Costos</span>
                                <span id="header-total-costos" class="badge bg-secondary rounded-pill"></span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th style="width: 30px;"><i class="bi bi-arrows-move"></i></th>
                                                <th style="width: 25%;">Ítem</th>
                                                <th style="width: 150px;">Tipo</th>
                                                <th style="width: 150px;">Valor</th>
                                                <th style="width: 120px;">Afecto IVA</th>
                                                <th style="width: 100px;">Mes Inicio</th>
                                                <th style="width: 100px;">Mes Fin</th>
                                                <th>Total (<span data-unit="currency"></span>)</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody id="costos-tbody"></tbody>
                                    </table>
                                </div>
                                <button id="add-costo" class="btn btn-sm btn-outline-primary mt-2">+ Agregar Costo</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- OTRAS PESTAÑAS -->
            <div class="tab-pane fade p-4 border rounded" id="eval" role="tabpanel" aria-labelledby="eval-tab-btn"><div id="evaluacion-container" data-initialized="false" class="text-center p-5"><p class="text-muted">Los resultados se actualizarán automáticamente.</p></div></div>
            <div class="tab-pane fade p-4 border rounded" id="flow" role="tabpanel" aria-labelledby="flow-tab-btn"><div id="flujo-caja-container" class="text-center p-5"><p class="text-muted">Los resultados se actualizarán automáticamente.</p></div></div>
            <div class="tab-pane fade p-4 border rounded" id="resumen" role="tabpanel" aria-labelledby="resumen-tab-btn"><div id="resumen-container" class="text-center p-5"><p class="text-muted">Los resultados se actualizarán automáticamente.</p></div></div>
            
            <!-- PESTAÑA GRÁFICO PERSONALIZADO -->
            <div class="tab-pane fade p-4 border rounded" id="grafico" role="tabpanel" aria-labelledby="grafico-tab-btn">
                <div id="grafico-container" data-initialized="false" class="text-center p-5">
                     <p class="text-muted">Los resultados se actualizarán automáticamente.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        const paramsTab = document.getElementById('params');
        const unidadesTbody = document.getElementById('unidades-tbody');
        const costosTbody = document.getElementById('costos-tbody');
        const deudaTbody = document.getElementById('deuda-tbody');
        const ingresosEtapasTbody = document.getElementById('ingresos-etapas-tbody');
        const currencySelect = document.getElementById('currency');
        let charts = {}; // Contenedor para todos los gráficos
        let fullDataCache = null; // Caché para los datos completos del cálculo
        let unidadCounter = 0, costoCounter = 0, ingresoEtapaCounter = 0, deudaCounter = 0;
        let simLayoutObserver = null;
        let timelineSliders = {};

        // START: New variables for Undo/Redo
        let undoStack = [];
        let redoStack = [];
        const MAX_HISTORY = 10;
        let isLoadingState = false; // Flag to prevent state saving during undo/redo
        // END: New variables for Undo/Redo

        const debounce = (func, delay) => {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        };
        
        // START: New functions for Undo/Redo
        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');

            if (undoBtn && redoBtn) {
                // Can undo if there's more than one state (the current one) in the stack
                undoBtn.disabled = undoStack.length <= 1;
                // Can redo if there are items in the redo stack
                redoBtn.disabled = redoStack.length === 0;
            }
        }

        function pushState() {
            if (isLoadingState) return;

            const currentState = getParams();
            const currentStateJSON = JSON.stringify(currentState);

            const lastStateJSON = undoStack.length > 0 ? undoStack[undoStack.length - 1] : null;

            if (currentStateJSON !== lastStateJSON) {
                undoStack.push(currentStateJSON);

                // Keep the stack size limited
                if (undoStack.length > MAX_HISTORY + 1) { // +1 for the current state
                    undoStack.shift();
                }

                // A new action clears the redo stack
                redoStack = [];
                updateUndoRedoButtons();
            }
        }

        function doUndo() {
            if (undoStack.length <= 1) return;

            isLoadingState = true;
            try {
                const currentStateJSON = undoStack.pop();
                redoStack.push(currentStateJSON);

                const prevStateJSON = undoStack[undoStack.length - 1];
                loadParamsFromJSON(JSON.parse(prevStateJSON));
            } catch (error) {
                console.error("Error during undo:", error);
                // Try to restore a valid state if something fails
                if(redoStack.length > 0) undoStack.push(redoStack.pop());
            } finally {
                isLoadingState = false;
                updateUndoRedoButtons();
            }
        }

        function doRedo() {
            if (redoStack.length === 0) return;

            isLoadingState = true;
            try {
                const nextStateJSON = redoStack.pop();
                undoStack.push(nextStateJSON);

                loadParamsFromJSON(JSON.parse(nextStateJSON));
            } catch (error) {
                console.error("Error during redo:", error);
                // Try to restore a valid state if something fails
                if(undoStack.length > 0) redoStack.push(undoStack.pop());
            } finally {
                isLoadingState = false;
                updateUndoRedoButtons();
            }
        }
        // END: New functions for Undo/Redo

        function evaluateFormula(expression) {
            if (typeof expression !== 'string' || expression.trim() === '') {
                return null;
            }
            // Reemplaza la coma decimal por un punto para el cálculo
            const sanitized = expression.replace(/,/g, '.').replace(/[^-()\d/*+.]/g, '');

            // Si después de sanitizar no queda nada, o es solo un número, no es una fórmula
            if (!sanitized || /^[-\d.]+$/.test(sanitized)) {
                return null;
            }

            try {
                // Usar el constructor de Function es un poco más seguro que eval() directo
                const result = new Function(`return ${sanitized}`)();
                // Verifica que el resultado sea un número finito
                if (typeof result === 'number' && isFinite(result)) {
                    return result;
                }
                return null;
            } catch (error) {
                // Si hay un error de sintaxis, no es una fórmula válida
                return null;
            }
        }
        function updateAllOutputs() {
            try {
                const data = runFullCalculation();
                if (!data) return;

                fullDataCache = data; // Store the latest calculation results

                // Actualiza el badge del crédito de construcción (sin cambios)
                const totalInteresesCredito = data.flujo.egresos['Intereses Crédito'] ? data.flujo.egresos['Intereses Crédito'].reduce((a, b) => a + b, 0) : 0;
                updateHeaderBadge('header-total-intereses', totalInteresesCredito);

                // Calcula el costo financiero total para las deudas adicionales
                let totalInteresesDeudaAdicional = 0;
                if (data.params.deudas) {
                    data.params.deudas.forEach((deuda, index) => {
                        // Construye la clave para el flujo de intereses basado en el nombre del ítem
                        const itemName = deuda.item || `Deuda ${index + 1}`;
                        const interesKey = `${itemName} (Intereses)`;
                        // Si el flujo de intereses existe, suma sus valores
                        if (data.flujo.egresos[interesKey]) {
                            totalInteresesDeudaAdicional += data.flujo.egresos[interesKey].reduce((a, b) => a + b, 0);
                        }
                    });
                }
                // Actualiza el badge de la tarjeta 'Deuda' con el total de intereses calculado
                updateHeaderBadge('header-total-deuda', totalInteresesDeudaAdicional);
                
                updateParamTabKPIsAndCards(data.params, data.calculosInternos);
                
                renderHeaderKPIs(data.flujo, data.params, data.calculosInternos);

                renderAndBindTimelineControls(data.params);
                
                renderGraficoTab_full(data);
                renderEvaluacion_full(data); 
                renderFlujoTabla_full(data);
                renderResumenTab_full(data);
                
                // After all calculations and UI updates, save the state for undo/redo
                pushState();

            } catch (error) { 
                console.error("Error al generar el flujo y actualizar UI:", error); 
            }
        }
        
        const debouncedUpdateAllOutputs = debounce(updateAllOutputs, 500);

        const parseFormattedNumber = (str) => {
            return parseFloat(String(str).replace(/\./g, '').replace(',', '.')) || 0;
        }
        const formatCurrency = (value, decimals = 0) => {
            if (isNaN(value)) return 'N/A';
            return new Intl.NumberFormat('es-CL', { 
                style: 'decimal', 
                minimumFractionDigits: decimals, 
                maximumFractionDigits: decimals 
            }).format(value);
        }
        const formatPercent = (v, decimals = 1) => isNaN(v)?'N/A':`${formatCurrency(v*100, decimals)}%`;

        const formatInputAsCurrency = (input) => {
            const decimals = parseInt(input.dataset.decimals) || 0;
            const value = parseFormattedNumber(input.value);
            input.value = formatCurrency(value, decimals);
        };
        const updateHeaderBadge = (elementId, value, decimals = 0) => {
            const badge = document.getElementById(elementId);
            if (badge) {
                const currency = currencySelect.value;
                badge.textContent = `${currency} ${formatCurrency(value, decimals)}`;
            }
        };

        function addUnidadRow(data = {}) {
            unidadCounter++;
            const newRow = document.createElement('tr');
            newRow.id = `unidad-row-${unidadCounter}`;
            newRow.innerHTML = `
                <td class="drag-handle"><i class="bi bi-grip-vertical"></i></td>
                <td><select class="form-control form-control-sm" name="tipoUnidad">${['departamento','casa','bodega','est_sup','est_sub', 'otro'].map(t => `<option value="${t}" ${data.tipo === t ? 'selected' : ''}>${t.replace('_', '. ').replace(/\b\w/g, l => l.toUpperCase())}</option>`).join('')}</select></td>
                <td><input type="text" class="form-control form-control-sm" name="nombreModelo" value="${data.nombre || ''}"></td>
                <td class="text-center-input"><input type="number" class="form-control form-control-sm text-center" name="cantidadUnidades" value="${data.cantidad || 0}" min="0" data-allow-formula="true"></td>
                <td class="text-center-input"><input type="text" class="form-control form-control-sm" data-format="number" data-decimals="1" name="superficieUnidad" value="${data.superficie || '0,0'}" data-allow-formula="true"></td>
                <td><input type="text" class="form-control form-control-sm" data-format="number" name="precioVenta" value="${data.precio || '0'}" data-allow-formula="true"></td>
                <td class="total-venta-row text-end">0</td>
                <td class="velocidad-venta-row text-center">0,0</td>
                <td><button type="button" class="btn btn-sm btn-outline-secondary" onclick="removeRow('unidad-row-${unidadCounter}')">X</button></td>
            `;
            unidadesTbody.appendChild(newRow);
            newRow.querySelectorAll('[data-format="number"]').forEach(formatInputAsCurrency);
            updateAllFastUI();
        }

        function addCostoRow(data = {}) {
            costoCounter++;
            const newRow = document.createElement('tr');
            newRow.id = `costo-row-${costoCounter}`;
            const tipo = data.tipo || 'gl';
            const valor = data.valor || '0';
            const decimals = (tipo === 'pct_venta' || tipo === 'pct_const') ? 2 : (tipo === 'unidad' ? 1 : 0);
            const afectoIVA = data.afectoIVA || 'si'; // Default to 'si'

            newRow.innerHTML = `
                <td class="drag-handle"><i class="bi bi-grip-vertical"></i></td>
                <td><input type="text" class="form-control form-control-sm" name="itemCosto" value="${data.item || ''}"></td>
                <td>
                    <select class="form-select form-select-sm" name="tipoCosto">
                        <option value="gl" ${tipo === 'gl' ? 'selected' : ''}>Global</option>
                        <option value="unidad" ${tipo === 'unidad' ? 'selected' : ''}>Por Unidad</option>
                        <option value="pct_venta" ${tipo === 'pct_venta' ? 'selected' : ''}>% Ventas</option>
                        <option value="pct_const" ${tipo === 'pct_const' ? 'selected' : ''}>% Costo Const.</option>
                    </select>
                </td>
                <td>
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control form-control-sm" data-format="number" data-decimals="${decimals}" name="valorCosto" value="${valor}" data-allow-formula="true">
                        <span class="input-group-text"></span>
                    </div>
                </td>
                <td>
                    <select class="form-select form-select-sm" name="afectoIVACosto">
                        <option value="si" ${afectoIVA === 'si' ? 'selected' : ''}>Sí</option>
                        <option value="no" ${afectoIVA === 'no' ? 'selected' : ''}>No</option>
                    </select>
                </td>
                <td><input type="number" class="form-control form-control-sm text-center" name="mesInicioCosto" value="${data.inicio || 1}" min="1"></td>
                <td><input type="number" class="form-control form-control-sm text-center" name="mesFinCosto" value="${data.fin || 1}" min="1"></td>
                <td class="total-costo-row text-end">0</td>
                <td><button type="button" class="btn btn-sm btn-outline-secondary" onclick="removeRow('costo-row-${costoCounter}')">X</button></td>
            `;
            costosTbody.appendChild(newRow);
            
            const tipoSelect = newRow.querySelector('[name="tipoCosto"]');
            tipoSelect.addEventListener('change', () => {
                updateValorCostoInput(newRow);
                updateAllFastUI();
                debouncedUpdateAllOutputs();
            });

            updateValorCostoInput(newRow);
            formatInputAsCurrency(newRow.querySelector('[name="valorCosto"]'));
            updateAllFastUI();
        }

        function addDeudaRow(data = {}) {
            deudaCounter++;
            const newRow = document.createElement('tr');
            newRow.id = `deuda-row-${deudaCounter}`;
            newRow.innerHTML = `
                <td><input type="text" class="form-control form-control-sm" name="itemDeuda" value="${data.item || ''}"></td>
                <td><input type="text" class="form-control form-control-sm" data-format="number" data-decimals="0" name="montoDeuda" value="${data.monto || '0'}" data-allow-formula="true"></td>
                <td><input type="text" class="form-control form-control-sm" data-format="number" data-decimals="2" name="tasaDeuda" value="${data.tasa || '0,00'}" data-allow-formula="true"></td>
                <td><input type="number" class="form-control form-control-sm text-center" name="inicioGirosDeuda" value="${data.inicioGiros || 1}" min="1"></td>
                <td><input type="number" class="form-control form-control-sm text-center" name="finGirosDeuda" value="${data.finGiros || 1}" min="1"></td>
                <td><input type="number" class="form-control form-control-sm text-center" name="inicioAbonosDeuda" value="${data.inicioAbonos || 1}" min="1"></td>
                <td><input type="number" class="form-control form-control-sm text-center" name="finAbonosDeuda" value="${data.finAbonos || 1}" min="1"></td>
                <td>
                    <select class="form-select form-select-sm" name="formaPagoDeuda">
                        <option value="Proporcional" ${data.formaPago === 'Proporcional' ? 'selected' : ''}>Proporcional</option>
                        <option value="Fija" ${data.formaPago === 'Fija' ? 'selected' : ''}>Fija</option>
                    </select>
                </td>
                <td><button type="button" class="btn btn-sm btn-outline-secondary" onclick="removeRow('deuda-row-${deudaCounter}')">X</button></td>
            `;
            deudaTbody.appendChild(newRow);
            newRow.querySelectorAll('[data-format="number"]').forEach(formatInputAsCurrency);
            updateAllFastUI();
        }

        function updateValorCostoInput(row) {
            const tipo = row.querySelector('[name="tipoCosto"]').value;
            const valorInput = row.querySelector('[name="valorCosto"]');
            const unitSpan = row.querySelector('.input-group-text');
            const currency = currencySelect.value;
            
            unitSpan.style.display = 'flex'; // Always show it

            if (tipo === 'pct_venta' || tipo === 'pct_const') {
                valorInput.dataset.decimals = "2";
                unitSpan.textContent = '%';
            } else {
                valorInput.dataset.decimals = (tipo === 'unidad') ? "1" : "0";
                unitSpan.textContent = currency;
            }
            formatInputAsCurrency(valorInput);
        }
        
        function addIngresoEtapaRow(data = {}) {
            ingresoEtapaCounter++;
            const newRow = document.createElement('tr');
            newRow.id = `ingreso-etapa-row-${ingresoEtapaCounter}`;
            newRow.innerHTML = `
                <td class="drag-handle"><i class="bi bi-grip-vertical"></i></td>
                <td><div class="input-group input-group-sm"><input type="text" class="form-control text-center" data-format="number" data-decimals="2" name="porcentajeIngreso" value="${data.porcentaje || '0,00'}" data-allow-formula="true"><span class="input-group-text">%</span></div></td>
                <td><input type="text" class="form-control form-control-sm" name="descripcionIngreso" value="${data.descripcion || ''}"></td>
                <td><input type="number" class="form-control form-control-sm text-center" name="mesInicioIngreso" value="${data.inicio || 1}" min="1"></td>
                <td><input type="number" class="form-control form-control-sm text-center" name="mesFinIngreso" value="${data.fin || 1}" min="1"></td>
                <td><button type="button" class="btn btn-sm btn-outline-secondary" onclick="removeRow('ingreso-etapa-row-${ingresoEtapaCounter}')">X</button></td>
            `;
            ingresosEtapasTbody.appendChild(newRow);
            formatInputAsCurrency(newRow.querySelector('[name="porcentajeIngreso"]'));
            updateIngresosEtapasPercentage();
        }
        
        function updateIngresosEtapasPercentage(changedInput = null) {
            const rows = ingresosEtapasTbody.querySelectorAll('tr');
            if (rows.length === 0) {
                document.getElementById('header-total-ingresos-pct').textContent = '0,00%';
                return;
            }

            let totalPct = 0;
            rows.forEach(row => {
                totalPct += parseFormattedNumber(row.querySelector('[name="porcentajeIngreso"]').value) || 0;
            });

            if (totalPct > 100 && changedInput) {
                const prevValue = parseFormattedNumber(changedInput.dataset.previousValue) || 0;
                changedInput.value = formatCurrency(prevValue, 2);
                totalPct = 0;
                rows.forEach(row => {
                    totalPct += parseFormattedNumber(row.querySelector('[name="porcentajeIngreso"]').value) || 0;
                });
            }
            
            const badge = document.getElementById('header-total-ingresos-pct');
            badge.textContent = `${formatCurrency(totalPct, 2)}%`;
            badge.classList.toggle('bg-success', Math.round(totalPct) === 100);
            badge.classList.toggle('bg-danger', Math.round(totalPct) !== 100);
        }

        window.removeRow = function(rowId) {
            const row = document.getElementById(rowId);
            const isIngresoRow = row.id.startsWith('ingreso-etapa-row-');
            row.remove();
            if (isIngresoRow) {
                updateIngresosEtapasPercentage();
            }
            updateAllFastUI();
            debouncedUpdateAllOutputs(); 
        }
        
        function getUnidadesResidencialesCount() {
            return Array.from(unidadesTbody.querySelectorAll('tr')).reduce((count, row) => {
                const tipo = row.querySelector('[name=tipoUnidad]').value;
                if(tipo === 'casa' || tipo === 'departamento') {
                    count += parseInt(row.querySelector('[name="cantidadUnidades"]').value) || 0;
                }
                return count;
            }, 0);
        }

        function updateVelocidadVenta() {
            const mesInicioVenta = parseInt(document.getElementById('mesInicioVenta').value) || 0;
            const mesFinNodes = Array.from(ingresosEtapasTbody.querySelectorAll('[name="mesFinIngreso"]'));
            const maxMesFin = mesFinNodes.length > 0 ? Math.max(...mesFinNodes.map(n => parseInt(n.value) || 0)) : 0;

            const duracionVenta = maxMesFin - mesInicioVenta;

            unidadesTbody.querySelectorAll('tr').forEach(row => {
                const cantidad = parseInt(row.querySelector('[name="cantidadUnidades"]').value) || 0;
                const velocidadCell = row.querySelector('.velocidad-venta-row');
                
                if (velocidadCell) {
                    if (duracionVenta > 0) {
                        const velocidad = cantidad / duracionVenta;
                        velocidadCell.textContent = formatCurrency(velocidad, 1);
                    } else {
                        velocidadCell.textContent = 'N/A';
                    }
                }
            });
        }

        function updateEscriturasMes() {
            const totalUnidades = getUnidadesResidencialesCount();

            const mesInicioNodes = Array.from(ingresosEtapasTbody.querySelectorAll('[name="mesInicioIngreso"]'));
            const mesFinNodes = Array.from(ingresosEtapasTbody.querySelectorAll('[name="mesFinIngreso"]'));

            const badge = document.getElementById('header-escrituras-mes');
            if (!badge) return;

            if (mesInicioNodes.length === 0 || mesFinNodes.length === 0) {
                badge.textContent = '';
                return;
            }

            const minMesInicio = Math.min(...mesInicioNodes.map(n => parseInt(n.value) || Infinity));
            const maxMesFin = Math.max(...mesFinNodes.map(n => parseInt(n.value) || 0));

            const duracion = maxMesFin - minMesInicio;

            if (isFinite(minMesInicio) && duracion > 0) {
                const escriturasPorMes = totalUnidades / duracion;
                badge.textContent = `${formatCurrency(escriturasPorMes, 1)} esc/mes`;
            } else {
                badge.textContent = 'N/A';
            }
        }

        function updateVentaTotals() {
            let casaCount = 0; let deptoCount = 0;
            const grandTotalVentas = Array.from(unidadesTbody.querySelectorAll('tr')).reduce((total, row) => {
                const cantidad = parseFloat(row.querySelector('[name="cantidadUnidades"]').value) || 0;
                const precio = parseFormattedNumber(row.querySelector('[name="precioVenta"]').value);
                const tipo = row.querySelector('[name=tipoUnidad]').value;
                if(tipo === 'casa') casaCount += cantidad;
                if(tipo === 'departamento') deptoCount += cantidad;
                row.querySelector('.total-venta-row').textContent = formatCurrency(cantidad * precio);
                return total + (cantidad * precio);
            }, 0);
            document.getElementById('total-casas').textContent = formatCurrency(casaCount);
            document.getElementById('total-deptos').textContent = formatCurrency(deptoCount);
            updateHeaderBadge('header-total-ventas', grandTotalVentas);
            updateCostosTotals();
            updateComisionVentasTotals();
        }
        
        function updateCostosTotals() {
            const totalVentas = Array.from(unidadesTbody.querySelectorAll('tr')).reduce((total, row) => total + ( (parseFormattedNumber(row.querySelector('[name="cantidadUnidades"]').value) || 0) * parseFormattedNumber(row.querySelector('[name="precioVenta"]').value) ), 0);
            const totalConstruccion = parseFloat(document.getElementById('construction-card-body').dataset.costoTotal) || 0;
            const totalUnidadesResidenciales = getUnidadesResidencialesCount();
            
            const grandTotal = Array.from(costosTbody.querySelectorAll('tr')).reduce((total, row) => {
                const tipo = row.querySelector('[name="tipoCosto"]').value;
                const valor = parseFormattedNumber(row.querySelector('[name="valorCosto"]').value);
                let totalFila = 0;

                switch(tipo) {
                    case 'gl':
                        totalFila = valor;
                        break;
                    case 'unidad':
                        totalFila = valor * totalUnidadesResidenciales;
                        break;
                    case 'pct_venta':
                        totalFila = (valor / 100) * totalVentas;
                        break;
                    case 'pct_const':
                        totalFila = (valor / 100) * totalConstruccion;
                        break;
                }
                row.querySelector('.total-costo-row').textContent = formatCurrency(totalFila);
                return total + totalFila;
            }, 0);

            updateHeaderBadge('header-total-costos', grandTotal);
        }

        function updateDeudaTotals() {
            const grandTotal = Array.from(deudaTbody.querySelectorAll('tr')).reduce((total, row) => {
                return total + parseFormattedNumber(row.querySelector('[name="montoDeuda"]').value);
            }, 0);
            // This badge will be updated with interest later, so we comment this out to avoid confusion.
            // updateHeaderBadge('header-total-deuda', grandTotal);
        }

        function updateComisionVentasTotals() {
            const pCierre = parseFormattedNumber(document.getElementById('comisionCierre').value) || 0;
            const pEscritura = parseFormattedNumber(document.getElementById('comisionEscritura').value) || 0;
            const pRecuperacion = parseFormattedNumber(document.getElementById('comisionRecuperacion').value) || 0;
            const totalPorcentaje = pCierre + pEscritura + pRecuperacion;
            document.getElementById('totalPorcentajeComision').textContent = `${formatCurrency(totalPorcentaje, 2)}%`;
            const totalVentas = Array.from(unidadesTbody.querySelectorAll('tr')).reduce((total, row) => total + ( (parseFormattedNumber(row.querySelector('[name="cantidadUnidades"]').value) || 0) * parseFormattedNumber(row.querySelector('[name="precioVenta"]').value) ), 0);
            const totalMonto = totalVentas * (totalPorcentaje / 100);
            updateHeaderBadge('header-total-comision', totalMonto);
        }
        
        function updateTerrenoHeaderTotal() {
            const precio = parseFormattedNumber(document.getElementById('precioTerreno').value);
            updateHeaderBadge('header-total-terreno', precio);
        }
        function updateValorFromPrecio() {
            const superficie = parseFormattedNumber(document.getElementById('superficieTerreno').value);
            const precio = parseFormattedNumber(document.getElementById('precioTerreno').value);
            document.getElementById('valorTerrenoM2').value = superficie > 0 ? formatCurrency(precio / superficie, 2) : '0,00';
            updateTerrenoHeaderTotal();
        }
        function updatePrecioFromValor() {
            const superficie = parseFormattedNumber(document.getElementById('superficieTerreno').value);
            const valor = parseFormattedNumber(document.getElementById('valorTerrenoM2').value);
            document.getElementById('precioTerreno').value = formatCurrency(superficie * valor, 0);
            updateTerrenoHeaderTotal();
        }
        function updateCostoConstruccion() {
            const supSobre = parseFormattedNumber(document.getElementById('superficieLosaSobre').value);
            const supBajo = parseFormattedNumber(document.getElementById('superficieLosaBajo').value);
            const supUrb = parseFormattedNumber(document.getElementById('superficieUrbanizacion').value);
            const costoM2Sobre = parseFormattedNumber(document.getElementById('costoM2Sobre').value);
            const costoM2Bajo = parseFormattedNumber(document.getElementById('costoM2Bajo').value);
            const costoM2Urb = parseFormattedNumber(document.getElementById('costoM2Urbanizacion').value);
            const total = (supSobre * costoM2Sobre) + (supBajo * costoM2Bajo) + (supUrb * costoM2Urb);
            document.getElementById('construction-card-body').dataset.costoTotal = total;
            updateHeaderBadge('header-total-construccion', total);
        }
        
        function updateParamTabKPIsAndCards(params, calculosInternos) {
            document.getElementById('calculated-renta').textContent = formatCurrency(calculosInternos.totalRentaPagar, 0);
            document.getElementById('calculated-iva').textContent = formatCurrency(calculosInternos.totalIvaPagar, 0);
        }

        function updateAllFastUI() {
            updateAllCurrencyUnits();
            updateCostoConstruccion(); // Needs to run before costs for % cost construction
            updateVentaTotals(); // Includes updateCostosTotals()
            updateDeudaTotals();
            updateTerrenoHeaderTotal();
            updateVelocidadVenta();
            updateEscriturasMes();
        }
        
        function updateAllCurrencyUnits() {
            const currency = currencySelect.value;
            document.querySelectorAll('[data-unit="currency"]').forEach(span => { span.textContent = currency; });
            // Update units in the cost table
            costosTbody.querySelectorAll('tr').forEach(row => {
                const tipo = row.querySelector('[name="tipoCosto"]').value;
                const unitSpan = row.querySelector('.input-group-text');
                if (unitSpan && tipo !== 'pct_venta' && tipo !== 'pct_const') {
                    unitSpan.textContent = currency;
                }
            });
        }
        
        function getParams() {
            const params = {
                projectName: document.getElementById('projectName').value,
                currency: currencySelect.value,
                discountRate: parseFormattedNumber(document.getElementById('discountRate').value) / 100 || 0,
                taxRate: parseFormattedNumber(document.getElementById('taxRate').value) / 100 || 0,
                iva: parseFormattedNumber(document.getElementById('iva').value) / 100 || 0,
                mesCompraTerreno: parseInt(document.getElementById('mesCompraTerreno').value),
                mesInicioConstruccion: parseInt(document.getElementById('mesInicioConstruccion').value),
                mesTerminoConstruccion: parseInt(document.getElementById('mesTerminoConstruccion').value),
                terreno: {
                    superficie: parseFormattedNumber(document.getElementById('superficieTerreno').value),
                    precio: parseFormattedNumber(document.getElementById('precioTerreno').value)
                },
                construccion: { 
                    superficieLosaSobre: parseFormattedNumber(document.getElementById('superficieLosaSobre').value),
                    superficieLosaBajo: parseFormattedNumber(document.getElementById('superficieLosaBajo').value),
                    superficieUrbanizacion: parseFormattedNumber(document.getElementById('superficieUrbanizacion').value),
                    costoM2Sobre: parseFormattedNumber(document.getElementById('costoM2Sobre').value),
                    costoM2Bajo: parseFormattedNumber(document.getElementById('costoM2Bajo').value),
                    costoM2Urbanizacion: parseFormattedNumber(document.getElementById('costoM2Urbanizacion').value),
                    costoTotal: parseFloat(document.getElementById('construction-card-body').dataset.costoTotal) || 0, 
                    afectoIVA: document.getElementById('ivaAfectoConstruccion').value === 'si',
                    anticipo: parseFormattedNumber(document.getElementById('porcAnticipo').value) / 100 || 0, 
                    retencion: parseFormattedNumber(document.getElementById('porcRetencion').value) / 100 || 0, 
                    curvaSParam: parseFloat(document.getElementById('curvaSParam').value) || 10 
                },
                financiamiento: {
                    monto: parseFormattedNumber(document.getElementById('montoFinanciamiento').value),
                    tasa: parseFormattedNumber(document.getElementById('tasaInteresAnual').value) / 100 || 0,
                    cuotaAlzamiento: (parseFormattedNumber(document.getElementById('cuotaAlzamiento').value) || 0) / 100
                },
                comisionVentas: {
                    cierre: parseFormattedNumber(document.getElementById('comisionCierre').value)/100 || 0,
                    escritura: parseFormattedNumber(document.getElementById('comisionEscritura').value)/100 || 0,
                    recuperacion: parseFormattedNumber(document.getElementById('comisionRecuperacion').value)/100 || 0
                },
                unidades: [], 
                costos: [],
                deudas: [],
                ingresosEtapas: [],
                fechaInicio: document.getElementById('fechaInicio').value,
                mesInicioVenta: parseInt(document.getElementById('mesInicioVenta').value),
            };

            unidadesTbody.querySelectorAll('tr').forEach(r => params.unidades.push({ tipo: r.querySelector('[name=tipoUnidad]').value, nombre: r.querySelector('[name=nombreModelo]').value, cantidad: parseInt(r.querySelector('[name=cantidadUnidades]').value), superficie: parseFormattedNumber(r.querySelector('[name=superficieUnidad]').value), precio: parseFormattedNumber(r.querySelector('[name=precioVenta]').value) }));
            ingresosEtapasTbody.querySelectorAll('tr').forEach(r => params.ingresosEtapas.push({ porcentaje: parseFormattedNumber(r.querySelector('[name=porcentajeIngreso]').value) / 100 || 0, descripcion: r.querySelector('[name=descripcionIngreso]').value, inicio: parseInt(r.querySelector('[name=mesInicioIngreso]').value), fin: parseInt(r.querySelector('[name=mesFinIngreso]').value) }));
            costosTbody.querySelectorAll('tr').forEach(r => {
                const tipo = r.querySelector('[name=tipoCosto]').value;
                let valor = parseFormattedNumber(r.querySelector('[name=valorCosto]').value);
                if (tipo === 'pct_venta' || tipo === 'pct_const') {
                    valor = valor / 100; // Store as decimal for calculation
                }
                params.costos.push({
                    item: r.querySelector('[name=itemCosto]').value,
                    tipo: tipo,
                    valor: valor,
                    afectoIVA: r.querySelector('[name=afectoIVACosto]').value, // Will be 'si' or 'no'
                    inicio: parseInt(r.querySelector('[name=mesInicioCosto]').value),
                    fin: parseInt(r.querySelector('[name=mesFinCosto]').value)
                });
            });
            deudaTbody.querySelectorAll('tr').forEach(r => {
                params.deudas.push({
                    item: r.querySelector('[name=itemDeuda]').value,
                    monto: parseFormattedNumber(r.querySelector('[name=montoDeuda]').value),
                    tasa: (parseFormattedNumber(r.querySelector('[name=tasaDeuda]').value) / 100) || 0,
                    inicioGiros: parseInt(r.querySelector('[name=inicioGirosDeuda]').value),
                    finGiros: parseInt(r.querySelector('[name=finGirosDeuda]').value),
                    inicioAbonos: parseInt(r.querySelector('[name=inicioAbonosDeuda]').value),
                    finAbonos: parseInt(r.querySelector('[name=finAbonosDeuda]').value),
                    formaPago: r.querySelector('[name=formaPagoDeuda]').value
                });
            });
            return params;
        }

        function runFullCalculation(overrideParams = {}) {
            const params = { ...getParams(), ...overrideParams };
            if (params.ingresosEtapas.length === 0) return null;

            let maxMes = params.mesTerminoConstruccion;
            [...params.costos, ...params.ingresosEtapas, ...params.deudas.map(d => ({fin: d.finAbonos}))].forEach(item => maxMes = Math.max(maxMes, item.fin || 0));
            const duracionProyecto = maxMes > 0 ? maxMes + 24 : 1;
            const meses = Array.from({ length: duracionProyecto }, (_, i) => i + 1);
            
            const flujo = { meses, ingresos: {}, egresos: {}, totales: {}, auxiliares: {} };
            const distributeUniformly = (totalAmount, startDate, endDate, flowArray) => { const duration = endDate - startDate + 1; if (totalAmount > 0 && duration > 0) { let totalPaid = 0; for (let mes = startDate; mes <= endDate; mes++) { if (mes - 1 < duracionProyecto) { let paymentThisMonth = (mes < endDate) ? Math.round((totalAmount / duration) * 100) / 100 : totalAmount - totalPaid; totalPaid += paymentThisMonth; flowArray[mes - 1] += paymentThisMonth; } } } };
            
            const totalVentasBruto = params.unidades.reduce((s, u) => s + (u.cantidad * u.precio), 0);
            flujo.ingresos['Ingresos del Proyecto'] = Array(duracionProyecto).fill(0);
            params.ingresosEtapas.forEach(etapa => { if (etapa.porcentaje > 0 && etapa.fin >= etapa.inicio) { distributeUniformly(totalVentasBruto * etapa.porcentaje, etapa.inicio, etapa.fin, flujo.ingresos['Ingresos del Proyecto']); } });
            
            if(params.terreno.precio > 0) { flujo.egresos['Terreno'] = Array(duracionProyecto).fill(0); if (params.mesCompraTerreno -1 < duracionProyecto) { flujo.egresos['Terreno'][params.mesCompraTerreno -1] = params.terreno.precio; }}
            
            const c = params.construccion; 
            const duracionConst = params.mesTerminoConstruccion - params.mesInicioConstruccion + 1; 
            if (duracionConst > 0 && c.costoTotal > 0) { 
                flujo.egresos['Construcción (Anticipo)'] = Array(duracionProyecto).fill(0); 
                flujo.egresos['Construcción (Estados de pago)'] = Array(duracionProyecto).fill(0); 
                flujo.egresos['Construcción (Dev. Retención)'] = Array(duracionProyecto).fill(0); 
                
                const costoBaseConstruccion = c.costoTotal; 
                const cAnticipo = costoBaseConstruccion * c.anticipo;
                const cRetencion = costoBaseConstruccion * c.retencion;
                const cBase = costoBaseConstruccion - cAnticipo - cRetencion; 
                const paramK = c.curvaSParam; 

                if (cAnticipo > 0 && params.mesInicioConstruccion > 0) {
                    const mesPagoAnticipo = params.mesInicioConstruccion > 1 ? params.mesInicioConstruccion - 1 : 1;
                    if (mesPagoAnticipo - 1 < duracionProyecto) flujo.egresos['Construcción (Anticipo)'][mesPagoAnticipo - 1] = cAnticipo;
                }

                let totalPagadoS = 0;
                if (paramK <= 1) { // Curva Lineal
                    distributeUniformly(cBase, params.mesInicioConstruccion, params.mesTerminoConstruccion, flujo.egresos['Construcción (Estados de pago)']);
                } else { // Curva S
                    const sigmoid = (t, k) => 1 / (1 + Math.exp(-k * (t - 0.5)));
                    for (let i = 0; i < duracionConst; i++) {
                        let pagoMes;
                        if (i < duracionConst - 1) {
                            const t_end = (i + 1) / duracionConst; const cumulative_end = sigmoid(t_end, paramK);
                            const t_start = i / duracionConst; const cumulative_start = sigmoid(t_start, paramK);
                            pagoMes = cBase * (cumulative_end - cumulative_start); totalPagadoS += pagoMes;
                        } else { pagoMes = cBase - totalPagadoS; }
                        const mesPagoIndex = params.mesInicioConstruccion - 1 + i;
                        if (mesPagoIndex < duracionProyecto) flujo.egresos['Construcción (Estados de pago)'][mesPagoIndex] = pagoMes;
                    }
                }
                if (cRetencion > 0) { const mesPagoRetencion = params.mesTerminoConstruccion + 1; if (mesPagoRetencion - 1 < duracionProyecto) flujo.egresos['Construcción (Dev. Retención)'][mesPagoRetencion - 1] = cRetencion; }
            }

            const totalUnidadesResidenciales = params.unidades.reduce((count, u) => (u.tipo === 'casa' || u.tipo === 'departamento') ? count + u.cantidad : count, 0);
            const costoConstruccionTotal = params.construccion.costoTotal;
            params.costos.forEach(costo => {
                let totalCostoItem = 0;
                switch(costo.tipo) {
                    case 'gl': totalCostoItem = costo.valor; break;
                    case 'unidad': totalCostoItem = costo.valor * totalUnidadesResidenciales; break;
                    case 'pct_venta': totalCostoItem = costo.valor * totalVentasBruto; break;
                    case 'pct_const': totalCostoItem = costo.valor * costoConstruccionTotal; break;
                }
                flujo.egresos[costo.item] = Array(duracionProyecto).fill(0);
                distributeUniformly(totalCostoItem, costo.inicio, costo.fin, flujo.egresos[costo.item]);
            });

            const comisionCierrePorc = params.comisionVentas.cierre;
            if (comisionCierrePorc > 0) {
                const totalComisionCierre = totalVentasBruto * comisionCierrePorc;
                const mesInicioVenta = params.mesInicioVenta;
                const mesFinEtapasIngreso = params.ingresosEtapas.length > 0 
                    ? Math.max(...params.ingresosEtapas.map(e => e.fin)) 
                    : mesInicioVenta;
                
                flujo.egresos['Comisión Cierres'] = Array(duracionProyecto).fill(0);
                if (mesFinEtapasIngreso >= mesInicioVenta) {
                    distributeUniformly(totalComisionCierre, mesInicioVenta, mesFinEtapasIngreso, flujo.egresos['Comisión Cierres']);
                }
            }
            
            const comisionEscrituraRecupPorc = params.comisionVentas.escritura + params.comisionVentas.recuperacion;
            if (comisionEscrituraRecupPorc > 0) {
                flujo.egresos['Comisión Escrituras'] = meses.map((_, i) => (flujo.ingresos['Ingresos del Proyecto'][i] || 0) * comisionEscrituraRecupPorc);
            }
            
            const f = params.financiamiento; 
            if (f.monto > 0) { 
                flujo.ingresos['Crédito (Giros)'] = Array(duracionProyecto).fill(0); 
                flujo.egresos['Intereses Crédito'] = Array(duracionProyecto).fill(0); 
                flujo.egresos['Pago Principal Crédito'] = Array(duracionProyecto).fill(0); 
                let deudaAcumulada = 0, girosAcumulados = 0; const tasaMensual = f.tasa / 12; 
                const pagosConstAnticipo = flujo.egresos['Construcción (Anticipo)'] || []; 
                const pagosConstProgreso = flujo.egresos['Construcción (Estados de pago)'] || []; 
                const totalPagosConstruccionReales = pagosConstAnticipo.reduce((a, b) => a + b, 0) + pagosConstProgreso.reduce((a, b) => a + b, 0); 
                for (let i = 0; i < duracionProyecto; i++) { 
                    if (deudaAcumulada > 0) flujo.egresos['Intereses Crédito'][i] = deudaAcumulada * tasaMensual;
                    const pagoConstruccionMes = (pagosConstAnticipo[i] || 0) + (pagosConstProgreso[i] || 0); 
                    if (pagoConstruccionMes > 0 && totalPagosConstruccionReales > 0) { 
                        let giroMes = f.monto * (pagoConstruccionMes / totalPagosConstruccionReales); 
                        if (girosAcumulados + giroMes > f.monto) giroMes = f.monto - girosAcumulados;
                        if ((i + 1 === params.mesTerminoConstruccion) && (girosAcumulados < f.monto)) giroMes = f.monto - girosAcumulados;
                        if (giroMes > 0) { flujo.ingresos['Crédito (Giros)'][i] = giroMes; deudaAcumulada += giroMes; girosAcumulados += giroMes; } 
                    } 
                    const ingresosMes = flujo.ingresos['Ingresos del Proyecto'][i] || 0; 
                    if (ingresosMes > 0 && deudaAcumulada > 0) { 
                        const pagoReal = Math.min(ingresosMes * f.cuotaAlzamiento, deudaAcumulada); 
                        if (pagoReal > 0) { flujo.egresos['Pago Principal Crédito'][i] = pagoReal; deudaAcumulada -= pagoReal; } 
                    } 
                } 
            }

            params.deudas.forEach((deuda, index) => {
                if(deuda.monto <= 0) return;
                const itemName = deuda.item || `Deuda ${index + 1}`;
                const giroKey = `${itemName} (Giros)`;
                const interesKey = `${itemName} (Intereses)`;
                const principalKey = `${itemName} (Pago Principal)`;
                
                flujo.ingresos[giroKey] = Array(duracionProyecto).fill(0);
                flujo.egresos[interesKey] = Array(duracionProyecto).fill(0);
                flujo.egresos[principalKey] = Array(duracionProyecto).fill(0);
                
                distributeUniformly(deuda.monto, deuda.inicioGiros, deuda.finGiros, flujo.ingresos[giroKey]);

                if (deuda.formaPago === 'Fija') {
                    distributeUniformly(deuda.monto, deuda.inicioAbonos, deuda.finAbonos, flujo.egresos[principalKey]);
                } else { 
                    const totalIngresosPeriodoAbono = flujo.ingresos['Ingresos del Proyecto'].slice(deuda.inicioAbonos - 1, deuda.finAbonos).reduce((a, b) => a + b, 0);
                    if (totalIngresosPeriodoAbono > 0) {
                        let principalPagado = 0;
                        for (let mes = deuda.inicioAbonos; mes <= deuda.finAbonos; mes++) {
                            const ingresoMes = flujo.ingresos['Ingresos del Proyecto'][mes-1] || 0;
                            const proporcionMes = ingresoMes / totalIngresosPeriodoAbono;
                            let pagoPrincipalMes = (mes < deuda.finAbonos) ? deuda.monto * proporcionMes : deuda.monto - principalPagado;
                            principalPagado += pagoPrincipalMes;
                            flujo.egresos[principalKey][mes-1] = pagoPrincipalMes;
                        }
                    }
                }

                const tasaMensual = deuda.tasa / 12;
                let outstandingBalance = 0; 
                for (let i = 0; i < duracionProyecto; i++) {
                    flujo.egresos[interesKey][i] = (outstandingBalance > 0) ? outstandingBalance * tasaMensual : 0;
                    outstandingBalance += (flujo.ingresos[giroKey][i] || 0) - (flujo.egresos[principalKey][i] || 0);
                }
            });
            
            const totalCostosFinancieros = Object.keys(flujo.egresos).filter(k => k.includes('Intereses')).reduce((sum, k) => sum + flujo.egresos[k].reduce((a, b) => a + b, 0), 0);
            const costoTerreno = params.terreno.precio;
            const costoConstruccionBruto = params.construccion.costoTotal;
            const otrosCostosBrutos = params.costos.reduce((total, costo) => { let ct = 0; switch(costo.tipo){ case 'gl': ct=costo.valor;break; case 'unidad':ct=costo.valor*totalUnidadesResidenciales;break; case'pct_venta':ct=costo.valor*totalVentasBruto;break; case'pct_const':ct=costo.valor*costoConstruccionTotal;break; } return total+ct; },0);
            const comisionTotalPorc = params.comisionVentas.cierre + params.comisionVentas.escritura + params.comisionVentas.recuperacion;
            const costoComisionBruto = totalVentasBruto * comisionTotalPorc;
            const totalCostosBrutos = costoTerreno + costoConstruccionBruto + otrosCostosBrutos + costoComisionBruto;

            const tasaIVA = params.iva; 
            const baseIVAVenta = totalVentasBruto - costoTerreno; 
            const ivaVenta = baseIVAVenta > 0 ? baseIVAVenta * tasaIVA / (1 + tasaIVA) : 0;

            const costoConstruccionBrutoAfecto = params.construccion.afectoIVA ? costoConstruccionBruto : 0;
            const otrosCostosBrutosAfectos = params.costos.reduce((total, costo) => {
                if (costo.afectoIVA !== 'si') return total;
                let ct = 0; switch(costo.tipo){ case 'gl': ct=costo.valor;break; case 'unidad':ct=costo.valor*totalUnidadesResidenciales;break; case'pct_venta':ct=costo.valor*totalVentasBruto;break; case'pct_const':ct=costo.valor*costoConstruccionTotal;break; } return total+ct;
            }, 0);
            
            const costosBrutosAfectosIVA = costoConstruccionBrutoAfecto + otrosCostosBrutosAfectos + costoComisionBruto;
            const ivaCostos = costosBrutosAfectosIVA * tasaIVA / (1 + tasaIVA); 
            const totalIvaPagar = ivaVenta - ivaCostos;

            const tasaRenta = params.taxRate; 
            const baseImponible = totalVentasBruto - totalCostosBrutos - totalCostosFinancieros - totalIvaPagar;
            const totalRentaPagar = baseImponible > 0 ? baseImponible * tasaRenta : 0;
            const udi = baseImponible > 0 ? baseImponible * (1 - tasaRenta) : baseImponible;

            flujo.egresos['IVA a Pagar'] = Array(duracionProyecto).fill(0);
            flujo.egresos['Renta'] = Array(duracionProyecto).fill(0);
            const totalIngresosProyecto = (flujo.ingresos['Ingresos del Proyecto'] || []).reduce((a, b) => a + b, 0);
            if(totalIngresosProyecto > 0){
                for(let i=0; i<duracionProyecto; i++) {
                    const proporcionIngreso = flujo.ingresos['Ingresos del Proyecto'][i] / totalIngresosProyecto;
                    if(totalIvaPagar > 0) flujo.egresos['IVA a Pagar'][i] = totalIvaPagar * proporcionIngreso;
                    if(totalRentaPagar > 0) flujo.egresos['Renta'][i] = totalRentaPagar * proporcionIngreso;
                }
            }

            flujo.totales['Total Ingresos'] = meses.map((_, i) => Object.values(flujo.ingresos).reduce((s, arr) => s + (arr ? arr[i] : 0), 0));
            flujo.totales['Total Egresos'] = meses.map((_, i) => Object.values(flujo.egresos).reduce((s, arr) => s + (arr ? arr[i] : 0), 0));
            flujo.auxiliares['Flujo Financiado Después de Impuestos'] = meses.map((_, i) => flujo.totales['Total Ingresos'][i] - flujo.totales['Total Egresos'][i]);
            flujo.auxiliares['Flujo Financiado Antes de Impuestos'] = meses.map((_, i) => flujo.auxiliares['Flujo Financiado Después de Impuestos'][i] + (flujo.egresos['Renta']?.[i] || 0));
            
            flujo.auxiliares['Flujo Puro Después de Impuestos'] = meses.map((_, i) => {
                const totalInteresesMes = Object.keys(flujo.egresos).filter(k => k.includes('Intereses')).reduce((s, k) => s + (flujo.egresos[k]?.[i] || 0), 0);
                const totalPrincipalMes = Object.keys(flujo.egresos).filter(k => k.includes('Pago Principal')).reduce((s, k) => s + (flujo.egresos[k]?.[i] || 0), 0);
                const totalGirosMes = Object.keys(flujo.ingresos).filter(k => k.includes('Giros')).reduce((s, k) => s + (flujo.ingresos[k]?.[i] || 0), 0);
                return flujo.auxiliares['Flujo Financiado Después de Impuestos'][i] + totalInteresesMes + totalPrincipalMes - totalGirosMes;
            });
            flujo.auxiliares['Flujo Puro Antes de Impuestos'] = meses.map((_, i) => flujo.auxiliares['Flujo Puro Después de Impuestos'][i] + (flujo.egresos['Renta']?.[i] || 0));
            
            flujo.auxiliares['Deuda Bancaria'] = Array(duracionProyecto).fill(0); let deuda = 0; for (let i=0; i<duracionProyecto; i++) { deuda += (Object.keys(flujo.ingresos).filter(k => k.includes('Giros')).reduce((s, k) => s + (flujo.ingresos[k]?.[i] || 0), 0)) - (Object.keys(flujo.egresos).filter(k => k.includes('Pago Principal')).reduce((s, k) => s + (flujo.egresos[k]?.[i] || 0), 0)); flujo.auxiliares['Deuda Bancaria'][i] = deuda; }
            
            const flujoInversionista = Array(duracionProyecto).fill(0);
            let saldoAcumulado = 0;
            for (let i = 0; i < duracionProyecto; i++) {
                saldoAcumulado += flujo.auxiliares['Flujo Financiado Después de Impuestos'][i];
                if (saldoAcumulado < -0.01) { flujoInversionista[i] = saldoAcumulado; saldoAcumulado = 0; } 
                else if (saldoAcumulado > 0.01) { flujoInversionista[i] = saldoAcumulado; saldoAcumulado = 0; }
            }
            flujo.auxiliares['Aportes/Devoluciones Socios'] = flujoInversionista;

            const totalMontoFinanciamiento = (params.financiamiento.monto || 0) + params.deudas.reduce((s,d) => s + d.monto, 0);
            const aporteSocios = totalCostosBrutos + totalCostosFinancieros - totalMontoFinanciamiento;
            const udiVta = totalVentasBruto > 0 ? udi / totalVentasBruto : 0;
            const roiDi = aporteSocios > 0 ? udi / aporteSocios : 0;
            const calculosInternos = { aporteSocios, totalIvaPagar, totalRentaPagar, udi, udiVta, roiDi, totalCostosFinancieros, totalVentasBruto };

            return { flujo, params, calculosInternos };
        }
        
        const calculateVAN = (annualRate, cashflows) => {
            if (!cashflows || cashflows.length === 0 || typeof cashflows.reduce !== 'function') return 0;
            const monthlyRate = Math.pow(1 + annualRate, 1 / 12) - 1;
            return cashflows.reduce((van, flow, i) => van + flow / Math.pow(1 + monthlyRate, i + 1), 0);
        };
        
        const calculateTIR = (cashflows) => {
            if (!cashflows || !cashflows.some(v => v > 0) || !cashflows.some(v => v < 0)) {
                return NaN;
            }
            const MAX_ITERATIONS = 50; const PRECISION = 1e-7; let rate = 0.1 / 12;
            for (let i = 0; i < MAX_ITERATIONS; i++) {
                let npv = 0; let derivative = 0;
                for (let j = 0; j < cashflows.length; j++) {
                    npv += cashflows[j] / Math.pow(1 + rate, j + 1);
                    derivative += -(j + 1) * cashflows[j] / Math.pow(1 + rate, j + 2);
                }
                if (Math.abs(derivative) < PRECISION) return NaN;
                const newRate = rate - npv / derivative;
                if (Math.abs(newRate - rate) < PRECISION) {
                    const annualTIR = Math.pow(1 + newRate, 12) - 1;
                    if (isNaN(annualTIR)) return NaN;
                    return Math.min(1, Math.max(0, annualTIR));
                }
                rate = newRate;
            }
            return NaN;
        };


        function renderHeaderKPIs(flujo, params, calculosInternos) {
            const currency = params.currency;
            const updateKPIElement = (elId, value, formatter, sign = null, unit = '') => {
                const kpiEl = document.getElementById(elId);
                if (!kpiEl) return;
                const valueEl = kpiEl.querySelector('.header-kpi-value');
                if (isNaN(value)) {
                    valueEl.textContent = '--';
                    kpiEl.classList.remove('positive', 'negative');
                    return;
                }
                valueEl.textContent = `${unit} ${formatter(value)}`.trim();
                kpiEl.classList.remove('positive', 'negative');
                kpiEl.classList.add('positive'); // Always green for header KPIs
            };
            
            // --- Calculations ---
            const flujoFinanciadoDI = flujo.auxiliares['Flujo Financiado Después de Impuestos'] || [0];
            let acumulado = 0;
            const flujoAcumulado = flujoFinanciadoDI.map(f => acumulado += f);
            const flujoAcumuladoMinimo = Math.min(0, ...flujoAcumulado);

            const totalDeuda = (params.financiamiento.monto || 0) + params.deudas.reduce((s, d) => s + d.monto, 0);
            const inversion = Math.abs(flujoAcumuladoMinimo) + totalDeuda;
            const aportes = Math.abs(flujoAcumuladoMinimo);
            const utilidad = calculosInternos.udi || 0;
            const tir = calculateTIR(flujoFinanciadoDI);
            const roi = aportes > 0 ? utilidad / aportes : 0;
            const totalVentasBruto = calculosInternos.totalVentasBruto || 0;
            const unidades = params.unidades.filter(u => u.tipo === 'casa' || u.tipo === 'departamento').reduce((s, u) => s + u.cantidad, 0);
            const supVenta = params.unidades.reduce((s, u) => s + (u.cantidad * u.superficie), 0);
            
            const costosDeuda = calculosInternos.aporteSocios || 0;
            const deuda = totalDeuda;
            const intereses = calculosInternos.totalCostosFinancieros || 0;
            const van = calculateVAN(params.discountRate, flujoFinanciadoDI);
            const ros = totalVentasBruto > 0 ? utilidad / totalVentasBruto : 0;
            const costoConstr = params.construccion.costoTotal || 0;
            const estac = params.unidades.filter(u => u.tipo === 'est_sup' || u.tipo === 'est_sub').reduce((s, u) => s + u.cantidad, 0);
            const supConstr = (params.construccion.superficieLosaSobre || 0) + (params.construccion.superficieLosaBajo || 0) + (params.construccion.superficieUrbanizacion || 0);

            // --- DOM Updates ---
            updateKPIElement('header-kpi-inversion', inversion, v => formatCurrency(v, 0), null, currency);
            updateKPIElement('header-kpi-aportes', aportes, v => formatCurrency(v, 0), null, currency);
            updateKPIElement('header-kpi-utilidad', utilidad, v => formatCurrency(v, 0), utilidad, currency);
            updateKPIElement('header-kpi-tir', tir, v => formatPercent(v, 1), tir);
            updateKPIElement('header-kpi-roi', roi, v => formatPercent(v, 1), roi);
            updateKPIElement('header-kpi-venta', totalVentasBruto, v => formatCurrency(v, 0), null, currency);
            updateKPIElement('header-kpi-unidades', unidades, v => formatCurrency(v, 0));
            updateKPIElement('header-kpi-sup-venta', supVenta, v => `${formatCurrency(v, 0)} m²`);

            updateKPIElement('header-kpi-costos-deuda', costosDeuda, v => formatCurrency(v, 0), null, currency);
            updateKPIElement('header-kpi-deuda', deuda, v => formatCurrency(v, 0), null, currency);
            updateKPIElement('header-kpi-intereses', intereses, v => formatCurrency(v, 0), null, currency);
            updateKPIElement('header-kpi-van', van, v => formatCurrency(v, 0), van, currency);
            updateKPIElement('header-kpi-ros', ros, v => formatPercent(v, 1), ros);
            updateKPIElement('header-kpi-costo-constr', costoConstr, v => formatCurrency(v, 0), null, currency);
            updateKPIElement('header-kpi-estac', estac, v => formatCurrency(v, 0));
            updateKPIElement('header-kpi-sup-constr', supConstr, v => `${formatCurrency(v, 0)} m²`);
        }
        
         const renderFlujoTabla_full = ({ flujo, params }) => { 
            const container = document.getElementById('flujo-caja-container');
            container.className = ''; // Limpiar clases de placeholder para padding uniforme
            const startDate = new Date(params.fechaInicio + 'T00:00:00'); 
            const dateHeaders = flujo.meses.map((_, i) => { 
                const currentDate = new Date(startDate.getFullYear(), startDate.getMonth() + i, 1); 
                const month = String(currentDate.getMonth() + 1).padStart(2, '0'); 
                const year = String(currentDate.getFullYear()).slice(-2); 
                return `${month}/${year}`; 
            }); 
            
            const ingresoKeys = Object.keys(flujo.ingresos); 
            
            // --- START: Lógica de ordenamiento de Egresos Modificada ---
            const allEgressKeysFromFlow = Object.keys(flujo.egresos);

            // 1. Separar llaves de Principal e Intereses
            const principalKeys = allEgressKeysFromFlow.filter(k => k.includes('Pago Principal')).sort();
            const interestKeys = allEgressKeysFromFlow.filter(k => k.includes('Intereses')).sort();

            // 2. Obtener el resto de las llaves
            const otherEgressKeys = allEgressKeysFromFlow.filter(k => !k.includes('Pago Principal') && !k.includes('Intereses'));

            // 3. Crear el orden de referencia para el resto de las llaves
            const egresoOrderBase = ['Terreno', 'Construcción (Anticipo)', 'Construcción (Estados de pago)', 'Construcción (Dev. Retención)'];
            const costoItems = params.costos.map(c => c.item);
            const egresoOrderEnd = ['Comisión Cierres', 'Comisión Escrituras', 'IVA a Pagar', 'Renta'];
            const otherKeysOrderRef = [...egresoOrderBase, ...costoItems, ...egresoOrderEnd];

            // 4. Ordenar las "otras" llaves según la referencia
            const orderedOtherKeys = otherKeysOrderRef
                .filter(key => otherEgressKeys.includes(key));
            
            const remainingUnorderedKeys = otherEgressKeys.filter(key => !orderedOtherKeys.includes(key));

            // 5. Combinar todo en el orden final deseado
            const egressKeysInOrder = [
                ...principalKeys,
                ...interestKeys,
                ...orderedOtherKeys,
                ...remainingUnorderedKeys
            ].filter((key, index, self) => flujo.egresos[key] && self.indexOf(key) === index); // Asegurar unicidad y existencia
            // --- END: Lógica de ordenamiento de Egresos Modificada ---
            
            container.innerHTML = `<div class="table-responsive" style="max-height: none;"><table class="table table-striped table-bordered table-hover table-sm cashflow-table"><thead class="table-dark sticky-top"><tr><th></th><th></th>${dateHeaders.map(d => `<th>${d}</th>`).join('')}</tr><tr><th>Partida / Mes</th><th>Total</th>${flujo.meses.map(m => `<th>${m}</th>`).join('')}</tr></thead><tbody><tr class="bg-light fw-bold text-start"><td colspan="${flujo.meses.length+2}">INGRESOS</td></tr>${ingresoKeys.map(k=>renderRow(k,flujo.ingresos[k],false,true)).join('')}${renderRow('Total Ingresos',flujo.totales['Total Ingresos'],true)}<tr class="bg-light fw-bold text-start"><td colspan="${flujo.meses.length+2}">EGRESOS</td></tr>${egressKeysInOrder.map(k=>renderRow(k,flujo.egresos[k],false,true)).join('')}${renderRow('Total Egresos',flujo.totales['Total Egresos'],true)}</tbody><tbody class="table-group-divider"><tr><td colspan="${flujo.meses.length+2}" style="border:none;height:1rem;background:transparent !important;"></td></tr>${Object.keys(flujo.auxiliares).filter(k => k !== 'Flujo Puro Después de Impuestos').map(k => renderRow(k, flujo.auxiliares[k], true, false, k !== 'Deuda Bancaria')).join('')}</tbody></table></div>`; 
            
            function renderRow(title, data, isBold = false, isSub = false, showTotal = true){ 
                const total = showTotal ? data.reduce((a, b) => a + b, 0) : 0; 
                const totalHtml = showTotal ? formatCurrency(total) : ''; 
                const textAlignment = isSub ? 'padding-left: 2rem;' : ''; 
                return `<tr style="${isBold?'font-weight: bold;':''}"><td style="text-align: left; ${textAlignment}">${title}</td><td class="text-end">${totalHtml}</td>${data.map(v => `<td class="text-end">${formatCurrency(v)}</td>`).join('')}</tr>`; 
            } 
        };       
        function adjustSimHeight() {
            const simControlsContainer = document.getElementById('eval-timeline-controls-container');
            const rightCol = document.getElementById('eval-right-col');
            if (!simControlsContainer || !rightCol) return;

            const evalPane = document.getElementById('eval');
            if (!evalPane) return;

            const evalPaneTop = evalPane.getBoundingClientRect().top;
            const availableHeight = window.innerHeight - evalPaneTop - 24; // 24px for bottom margin/padding

            // Set height on both containers
            simControlsContainer.style.height = `${availableHeight}px`;
            rightCol.style.height = `${availableHeight}px`;
        }

        function findLastActiveMonth(arraysToSearch) {
            let lastIndex = 0;
            arraysToSearch.forEach(arr => {
                if (arr) {
                    for (let i = arr.length - 1; i >= 0; i--) {
                        if (Math.abs(arr[i]) > 0.01) {
                            lastIndex = Math.max(lastIndex, i);
                            break;
                        }
                    }
                }
            });
            return lastIndex;
        }

        function initializeEvalTab({ flujo, params }) {
            const container = document.getElementById('evaluacion-container');
            container.className = ''; // Limpiar clases de placeholder para padding uniforme
            container.innerHTML = `
                <div class="row g-4">
                    <div class="col-lg-3">
                        <div class="card h-100" id="simulation-card">
                            <div class="card-header fw-bold">Simulación</div>
                            <div class="card-body" id="eval-timeline-controls-container" style="overflow-y: auto; padding-right: 1rem;">
                                <!-- Sliders will be injected here -->
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-9" id="eval-right-col" style="overflow-y: auto;">
                        <div class="row g-4" id="charts-container">
                            <div class="col-12"><div class="card"><div class="card-body"><canvas id="flujoPuroChart"></canvas></div></div></div>
                            <div class="col-12"><div class="card"><div class="card-body"><canvas id="flujoMensualChart"></canvas></div></div></div>
                            <div class="col-12"><div class="card"><div class="card-body"><canvas id="flujoAcumuladoChart"></canvas></div></div></div>
                        </div>
                    </div>
                </div>`;
            
            renderAndBindTimelineControls(params);
            createCharts_full(flujo, params);
            
            // No longer need ResizeObserver for this layout
            // if (simLayoutObserver) simLayoutObserver.disconnect();
            
            // Initial height adjustment
            setTimeout(adjustSimHeight, 100);
        }

        function updateEvalCharts({ flujo, params }) {
            const lastActiveMonth = findLastActiveMonth([
                flujo.auxiliares['Flujo Puro Antes de Impuestos'],
                flujo.auxiliares['Flujo Financiado Después de Impuestos'],
                flujo.auxiliares['Aportes/Devoluciones Socios']
            ]);
            const displayLimit = lastActiveMonth + 2;

            const startDate = new Date(params.fechaInicio + 'T00:00:00');
            const chartLabels = flujo.meses.map((m, i) => {
                const currentDate = new Date(startDate.getFullYear(), startDate.getMonth() + i, 1);
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                const year = String(currentDate.getFullYear()).slice(-2);
                return `${m} (${month}-${year})`;
            }).slice(0, displayLimit);
            
            const positiveColor = 'rgba(25, 135, 84, 0.5)';
            const negativeColor = 'rgba(220, 53, 69, 0.5)';

            const updateChartData = (chartId, labels, newData, newColors) => {
                const chart = charts[chartId];
                if (chart) {
                    chart.data.labels = labels;
                    chart.data.datasets[0].data = newData.slice(0, displayLimit);
                    if (newColors) {
                        chart.data.datasets[0].backgroundColor = newColors.slice(0, displayLimit);
                    }
                    chart.update('none');
                }
            };

            updateChartData('flujoPuroChart', chartLabels, flujo.auxiliares['Flujo Puro Antes de Impuestos'], flujo.auxiliares['Flujo Puro Antes de Impuestos'].map(v => v >= 0 ? positiveColor : negativeColor));
            updateChartData('flujoMensualChart', chartLabels, flujo.auxiliares['Flujo Financiado Después de Impuestos'], flujo.auxiliares['Flujo Financiado Después de Impuestos'].map(v => v >= 0 ? positiveColor : negativeColor));
            
            let acumuladoPostImp = 0;
            const flujoAcumuladoPostImp = flujo.auxiliares['Flujo Financiado Después de Impuestos'].map(f => acumuladoPostImp += f);
            updateChartData('flujoAcumuladoChart', chartLabels, flujoAcumuladoPostImp);
        }

        const renderEvaluacion_full = (data) => {
            const container = document.getElementById('evaluacion-container');
            if (container.dataset.initialized !== 'true') {
                initializeEvalTab(data);
                container.dataset.initialized = 'true';
            } else {
                updateEvalCharts(data);
            }
        };

        function renderAndBindTimelineControls(params) {
            const controlsContainer = document.getElementById('eval-timeline-controls-container');
            if (!controlsContainer) return;

            timelineSliders = {};
            controlsContainer.innerHTML = '';

            let controlsHtml = '';
            const maxMonths = 120;

            const ensureId = (input, prefix, index) => {
                if (!input.id) input.id = `${prefix}-${index}`;
                return input.id;
            };

            const createSingleSlider = (label, inputId, min, max, step) => {
                const input = document.getElementById(inputId);
                if (!input) return '';
                const controlId = `timeline-${inputId}`;
                return `
                    <div class="mb-4 timeline-control">
                        <label class="form-label small">${label}</label>
                        <div id="${controlId}" data-input-id="${inputId}"></div>
                        <div class="timeline-control-inputs mt-2 justify-content-center">
                            <input type="number" class="form-control form-control-sm single-slider-input" value="${input.value}">
                        </div>
                    </div>
                `;
            };

            const createRangeSlider = (label, startInputId, endInputId) => {
                const startInput = document.getElementById(startInputId);
                const endInput = document.getElementById(endInputId);
                if (!startInput || !endInput) return '';

                const controlId = `timeline-${startInputId}`;
                return `
                    <div class="mb-4 timeline-control">
                        <label class="form-label small">${label}</label>
                        <div id="${controlId}" data-start-input-id="${startInputId}" data-end-input-id="${endInputId}"></div>
                        <div class="timeline-control-inputs mt-2">
                            <input type="number" class="form-control form-control-sm" data-handle="0" value="${startInput.value}">
                            <input type="number" class="form-control form-control-sm" data-handle="1" value="${endInput.value}">
                        </div>
                    </div>
                `;
            };
            
            let keyParamsHtml = '';
            keyParamsHtml += createSingleSlider('Mes Compra Terreno', 'mesCompraTerreno', 1, maxMonths, 1);
            keyParamsHtml += createSingleSlider('Curva S', 'curvaSParam', 1, 20, 1);
            
            let ingresosHtml = '<div class="section-header">Ingresos</div>';
            const ingresosRows = document.querySelectorAll('#ingresos-etapas-tbody tr');
            ingresosRows.forEach((row, index) => {
                const item = row.querySelector(`[name="descripcionIngreso"]`).value || `Etapa Ingreso ${index + 1}`;
                const inicioInput = row.querySelector(`input[name="mesInicioIngreso"]`);
                const finInput = row.querySelector(`input[name="mesFinIngreso"]`);
                ingresosHtml += createRangeSlider(item, ensureId(inicioInput, 'ing-ini', index), ensureId(finInput, 'ing-fin', index));
            });

            let costosHtml = '<div class="section-header">Costos</div>';
            costosHtml += createRangeSlider('Construcción', 'mesInicioConstruccion', 'mesTerminoConstruccion');
            
            const createCostSliders = (tbodyId, nameAttr, labelPrefix, idPrefix) => {
                let html = '';
                const rows = document.querySelectorAll(`#${tbodyId} tr`);
                rows.forEach((row, index) => {
                    const item = row.querySelector(`[name="${nameAttr}"]`).value || `${labelPrefix} ${index + 1}`;
                    const inicioInput = row.querySelector(`input[name^="mesInicio"]`);
                    const finInput = row.querySelector(`input[name^="mesFin"]`);
                    html += createRangeSlider(item, ensureId(inicioInput, `${idPrefix}-ini`, index), ensureId(finInput, `${idPrefix}-fin`, index));
                });
                return html;
            };
            
            costosHtml += createCostSliders('costos-tbody', 'itemCosto', 'Costo', 'costo');

            controlsContainer.innerHTML = keyParamsHtml + ingresosHtml + costosHtml;

            controlsContainer.querySelectorAll('.timeline-control > div[id^="timeline-"]').forEach(sliderEl => {
                if (sliderEl.dataset.inputId) {
                    const originalInput = document.getElementById(sliderEl.dataset.inputId);
                    const displayInput = sliderEl.nextElementSibling.querySelector('input');
                    const min = Number(originalInput.min) || 1;
                    const max = Number(originalInput.max) || maxMonths;
                    const step = Number(originalInput.step) || 1;

                    const slider = noUiSlider.create(sliderEl, {
                        start: [Number(originalInput.value)],
                        step: step, range: { 'min': min, 'max': max },
                        format: { to: value => Math.round(value), from: value => Number(value) }
                    });

                    slider.on('update', (values) => {
                        displayInput.value = values[0];
                        if (originalInput.value != values[0]) {
                            originalInput.value = values[0];
                        }
                        if (originalInput.id === 'curvaSParam') {
                            document.getElementById('curvaSValue').textContent = values[0];
                            drawSCurve(values[0]);
                        }
                    });
                    slider.on('change', debouncedUpdateAllOutputs);
                    displayInput.addEventListener('change', (e) => {
                        slider.set(e.target.value);
                        debouncedUpdateAllOutputs();
                    });
                    timelineSliders[originalInput.id] = { slider: slider, handle: 0 };
                }
                else if (sliderEl.dataset.startInputId) {
                    const startInput = sliderEl.nextElementSibling.querySelector('input[data-handle="0"]');
                    const endInput = sliderEl.nextElementSibling.querySelector('input[data-handle="1"]');
                    const originalStartInput = document.getElementById(sliderEl.dataset.startInputId);
                    const originalEndInput = document.getElementById(sliderEl.dataset.endInputId);

                    const slider = noUiSlider.create(sliderEl, {
                        start: [Number(startInput.value), Number(endInput.value)],
                        connect: true, step: 1, margin: 0, behaviour: 'drag',
                        range: { 'min': 1, 'max': maxMonths },
                        format: { to: value => Math.round(value), from: value => Number(value) }
                    });

                    slider.on('update', (values) => {
                        startInput.value = values[0];
                        endInput.value = values[1];
                        if (originalStartInput && originalStartInput.value != values[0]) originalStartInput.value = values[0];
                        if (originalEndInput && originalEndInput.value != values[1]) originalEndInput.value = values[1];
                    });
                    
                    slider.on('change', debouncedUpdateAllOutputs);

                    [startInput, endInput].forEach(input => {
                        input.addEventListener('change', (e) => {
                            const values = [startInput.value, endInput.value];
                            slider.set(values);
                            debouncedUpdateAllOutputs();
                        });
                    });
                    if (originalStartInput) timelineSliders[originalStartInput.id] = { slider: slider, handle: 0 };
                    if (originalEndInput) timelineSliders[originalEndInput.id] = { slider: slider, handle: 1 };
                }
            });
        }

        const createCharts_full = (flujo, params) => { 
            const lastActiveMonth = findLastActiveMonth([
                flujo.auxiliares['Flujo Puro Antes de Impuestos'],
                flujo.auxiliares['Flujo Financiado Después de Impuestos'],
                flujo.auxiliares['Aportes/Devoluciones Socios']
            ]);
            const displayLimit = lastActiveMonth + 2;

            const startDate = new Date(params.fechaInicio + 'T00:00:00');
            const chartLabels = flujo.meses.map((m, i) => {
                const currentDate = new Date(startDate.getFullYear(), startDate.getMonth() + i, 1);
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                const year = String(currentDate.getFullYear()).slice(-2);
                return `${m} (${month}-${year})`;
            }).slice(0, displayLimit);

            const positiveColor = 'rgba(25, 135, 84, 0.5)';
            const negativeColor = 'rgba(220, 53, 69, 0.5)';
            const lineColor = 'rgba(25, 135, 84, 1)';
            const fillColor = 'rgba(25, 135, 84, 0.2)';

            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: { display: true, text: 'Mes / Fecha' },
                        ticks: { maxRotation: 90, minRotation: 90, autoSkip: true, maxTicksLimit: 60 }
                    },
                    y: {
                        title: { display: true, text: `Flujo (${params.currency})` },
                        ticks: { callback: value => formatCurrency(value, 0) }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) { label += formatCurrency(context.parsed.y, 0); }
                                return label;
                            }
                        }
                    }
                }
            };

            const createChart = (id, config) => { 
                if (charts[id]) charts[id].destroy(); 
                const canvas = document.getElementById(id);
                if(canvas) charts[id] = new Chart(canvas, config); 
            }; 

            createChart('flujoPuroChart', { 
                type: 'bar', 
                data: { 
                    labels: chartLabels, 
                    datasets: [{ 
                        label: 'Flujo Puro (A.I.)', 
                        data: flujo.auxiliares['Flujo Puro Antes de Impuestos'].slice(0, displayLimit), 
                        backgroundColor: flujo.auxiliares['Flujo Puro Antes de Impuestos'].slice(0, displayLimit).map(v => v >= 0 ? positiveColor : negativeColor) 
                    }] 
                }, 
                options: { ...commonOptions, plugins: { ...commonOptions.plugins, title: { display: true, text: 'Flujo de Caja Mensual (Puro A.I.)' } } }
            });

            createChart('flujoMensualChart', { 
                type: 'bar', 
                data: { 
                    labels: chartLabels, 
                    datasets: [{ 
                        label: 'Flujo Financiado (D.I.)', 
                        data: flujo.auxiliares['Flujo Financiado Después de Impuestos'].slice(0, displayLimit), 
                        backgroundColor: flujo.auxiliares['Flujo Financiado Después de Impuestos'].slice(0, displayLimit).map(v => v >= 0 ? positiveColor : negativeColor) 
                    }] 
                }, 
                options: { ...commonOptions, plugins: { ...commonOptions.plugins, title: { display: true, text: 'Flujo de Caja Mensual (Financiado D.I.)' } } }
            }); 
            
            let acumuladoPostImp = 0; 
            const flujoAcumuladoPostImp = flujo.auxiliares['Flujo Financiado Después de Impuestos'].map(f => acumuladoPostImp += f); 
            createChart('flujoAcumuladoChart', { 
                type: 'line', 
                data: { 
                    labels: chartLabels, 
                    datasets: [{ 
                        label: 'Flujo Acumulado (D.I.)', 
                        data: flujoAcumuladoPostImp.slice(0, displayLimit), 
                        fill: true, 
                        backgroundColor: fillColor, 
                        borderColor: lineColor 
                    }] 
                }, 
                options: { ...commonOptions, plugins: { ...commonOptions.plugins, title: { display: true, text: 'Flujo de Caja Acumulado (Financiado D.I.)' } } }
            });
            
            setTimeout(adjustSimHeight, 100);
        };
        
         const renderResumenTab_full = ({ flujo, params, calculosInternos }) => {
            const container = document.getElementById('resumen-container');
            container.className = ''; // Limpiar clases de placeholder para padding uniforme
            if (!flujo || !flujo.auxiliares || Object.keys(flujo.auxiliares).length === 0) {
                container.innerHTML = '<p class="text-muted">Genere un flujo de caja en la pestaña de parámetros para ver el resumen.</p>';
                return;
            }

            const totalVentasBruto = (flujo.ingresos['Ingresos del Proyecto'] || []).reduce((a, b) => a + b, 0);
            const totalUnidades = getUnidadesResidencialesCount();
            const tasaIVA = params.iva;
            const factorIVA = tasaIVA / (1 + tasaIVA);

            const calculateIvaAndNet = (itemKey, totalBruto) => {
                let esAfecto = false;
                
                if (itemKey === 'Ingresos del Proyecto') {
                    const ivaVenta = (totalVentasBruto - params.terreno.precio) * factorIVA;
                    return { iva: ivaVenta, neto: totalBruto - ivaVenta };
                }
                
                if (itemKey.startsWith('Construcción')) {
                    esAfecto = params.construccion.afectoIVA;
                } else if (itemKey.startsWith('Comisión')) {
                    esAfecto = true;
                } else if (itemKey === 'Terreno' || itemKey === 'IVA a Pagar' || itemKey === 'Renta' || itemKey.includes('Intereses') || itemKey.includes('Pago Principal')) {
                    esAfecto = false;
                } else {
                    const costoParam = params.costos.find(c => c.item === itemKey);
                    if(costoParam) esAfecto = (costoParam.afectoIVA === 'si');
                }

                const iva = esAfecto ? (totalBruto * factorIVA) : 0;
                const neto = totalBruto - iva;
                return { iva, neto };
            };
            
            const tableItems = [];
            // INGRESOS
            Object.entries(flujo.ingresos).forEach(([name, data]) => {
                if (!name.toLowerCase().includes('crédito') && !name.toLowerCase().includes('deuda') && !name.toLowerCase().includes('giros')) {
                    const totalBruto = data.reduce((a, b) => a + b, 0);
                    const { iva, neto } = calculateIvaAndNet(name, totalBruto);
                    tableItems.push({ name, total: totalBruto, iva, neto, type: 'ingreso' });
                }
            });

            // EGRESOS
            // --- START: Lógica de ordenamiento de Egresos Modificada ---
            const allEgressKeys = Object.keys(flujo.egresos);

            // 1. Obtener la configuración de intereses (y renombrarla para mostrar). Los pagos de principal se ignoran.
            const interestKeys = allEgressKeys.filter(k => k.includes('Intereses')).sort();
            const interestConfig = interestKeys.map(k => ({ key: k, displayName: k.replace('Intereses', 'Costo financiero') }));

            // 2. Definir el orden de los otros costos en dos partes: antes y después de los intereses.
            const egresoOrderPart1 = [
                { key: 'Terreno' },
                { key: 'Construcción (Anticipo)' },
                { key: 'Construcción (Estados de pago)' },
                { key: 'Construcción (Dev. Retención)' },
                ...params.costos.map(c => ({ key: c.item })),
                { key: 'Comisión Cierres' },
                { key: 'Comisión Escrituras' }
            ];

            const egresoOrderPart2 = [
                { key: 'IVA a Pagar' },
                { key: 'Renta' }
            ];

            // 3. Ensamblar la configuración final en el orden deseado.
            const egresoOrderConfig = [
                ...egresoOrderPart1,
                ...interestConfig, // Intereses se insertan aquí
                ...egresoOrderPart2
            ];
            
            const uniqueEgresoConfig = egresoOrderConfig.reduce((acc, current) => { if (!acc.find(item => item.key === current.key)) { acc.push(current); } return acc; }, []);
            // --- END: Lógica de ordenamiento de Egresos Modificada ---

            for (const config of uniqueEgresoConfig) {
                const data = flujo.egresos[config.key];
                if (data) {
                    const totalBruto = data.reduce((a, b) => a + b, 0);
                    if (Math.abs(totalBruto) > 0.001) {
                         const { iva, neto } = calculateIvaAndNet(config.key, totalBruto);
                         tableItems.push({ name: config.displayName || config.key, total: totalBruto, iva, neto, type: 'egreso' });
                    }
                }
            }

            const totalCostosBrutosEnTabla = tableItems.filter(i=>i.type === 'egreso').reduce((s,i)=>s+i.total,0);

            const renderRow = (item) => {
                const pctVentas = totalVentasBruto > 0 ? item.total / totalVentasBruto : 0;
                const porUnidad = totalUnidades > 0 ? item.total / totalUnidades : 0;
                let pctCostosContent = '-';
                if (item.type === 'egreso' && totalCostosBrutosEnTabla > 0) {
                    pctCostosContent = formatPercent(item.total / totalCostosBrutosEnTabla, 1);
                } else if (item.name === 'Ingresos del Proyecto' && totalCostosBrutosEnTabla > 0) {
                     pctCostosContent = formatPercent(item.total / totalCostosBrutosEnTabla, 1);
                }
                
                let netoCellContent = formatCurrency(item.neto, 0);
                if (item.name === 'IVA a Pagar') {
                    netoCellContent = '-';
                }

                return `<tr>
                    <td class="text-start">${item.name}</td>
                    <td class="text-end">${formatCurrency(item.total, 0)}</td>
                    <td class="text-end">${formatPercent(pctVentas, 1)}</td>
                    <td class="text-end">${pctCostosContent}</td>
                    <td class="text-end">${formatCurrency(porUnidad, 1)}</td>
                    <td class="text-end">${formatCurrency(item.iva, 0)}</td>
                    <td class="text-end">${netoCellContent}</td>
                </tr>`;
            };

            const ingresosForTable = tableItems.filter(i => i.type === 'ingreso');
            const egresosForTable = tableItems.filter(i => i.type === 'egreso');
            
            const sum = (arr, prop) => arr.reduce((s, item) => s + item[prop], 0);

            const totalIngresosBruto = sum(ingresosForTable, 'total');
            const totalIngresosIVA = sum(ingresosForTable, 'iva');
            const totalIngresosNeto = sum(ingresosForTable, 'neto');

            const totalEgresosBruto = sum(egresosForTable, 'total');
            const totalEgresosIVA = sum(egresosForTable, 'iva');
            const totalEgresosNeto = sum(egresosForTable.filter(item => item.name !== 'IVA a Pagar'), 'neto');

            const udiBruto = totalIngresosBruto - totalEgresosBruto;
            const udiIVA = totalIngresosIVA - totalEgresosIVA;
            const udiNeto = totalIngresosNeto - totalEgresosNeto;

            const calcAndFormat = (total, base, formatter) => base > 0 ? formatter(total / base) : '-';

            let summaryTableHtml = `
                <div class="card mt-4" id="summary-table-card">
                    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                        <span>Ingresos y Egresos</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: none;">
                            <table class="table table-sm table-striped">
                                <thead class="table-light">
                                    <tr>
                                        <th class="text-start">Ítem</th>
                                        <th class="text-end">Total (<span data-unit="currency">${params.currency}</span>)</th>
                                        <th class="text-end">% Ventas</th>
                                        <th class="text-end">% Costo</th>
                                        <th class="text-end">(<span data-unit="currency">${params.currency}</span>)/Unidad</th>
                                        <th class="text-end">IVA (<span data-unit="currency">${params.currency}</span>)</th>
                                        <th class="text-end">Total Neto (<span data-unit="currency">${params.currency}</span>)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="bg-secondary bg-opacity-10 fw-bold"><td colspan="7" class="text-start">INGRESOS</td></tr>
                                    ${ingresosForTable.map(renderRow).join('')}
                                    <tr class="table-group-divider fw-bold">
                                        <td class="text-start">Total Ingresos</td>
                                        <td class="text-end">${formatCurrency(totalIngresosBruto, 0)}</td>
                                        <td class="text-end">${calcAndFormat(totalIngresosBruto, totalVentasBruto, v => formatPercent(v,1))}</td>
                                        <td class="text-end">-</td>
                                        <td class="text-end">${calcAndFormat(totalIngresosBruto, totalUnidades, v => formatCurrency(v,1))}</td>
                                        <td class="text-end">${formatCurrency(totalIngresosIVA, 0)}</td>
                                        <td class="text-end">${formatCurrency(totalIngresosNeto, 0)}</td>
                                    </tr>
                                    <tr class="bg-secondary bg-opacity-10 fw-bold"><td colspan="7" class="text-start">EGRESOS</td></tr>
                                    ${egresosForTable.map(renderRow).join('')}
                                    <tr class="table-group-divider fw-bold">
                                        <td class="text-start">Total Egresos</td>
                                        <td class="text-end">${formatCurrency(totalEgresosBruto, 0)}</td>
                                        <td class="text-end">${calcAndFormat(totalEgresosBruto, totalVentasBruto, v => formatPercent(v,1))}</td>
                                        <td class="text-end">${calcAndFormat(totalEgresosBruto, totalEgresosBruto, v => formatPercent(v,1))}</td>
                                        <td class="text-end">${calcAndFormat(totalEgresosBruto, totalUnidades, v => formatCurrency(v,1))}</td>
                                        <td class="text-end">${formatCurrency(totalEgresosIVA, 0)}</td>
                                        <td class="text-end">${formatCurrency(totalEgresosNeto, 0)}</td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr class="table-group-divider fw-bold bg-light">
                                        <td class="text-start">Margen (UDI)</td>
                                        <td class="text-end">${formatCurrency(udiBruto, 0)}</td>
                                        <td class="text-end">${calcAndFormat(udiBruto, totalVentasBruto, v => formatPercent(v,1))}</td>
                                        <td class="text-end">-</td>
                                        <td class="text-end">${calcAndFormat(udiBruto, totalUnidades, v => formatCurrency(v,1))}</td>
                                        <td class="text-end">${formatCurrency(udiIVA, 0)}</td>
                                        <td class="text-end">${formatCurrency(udiNeto, 0)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = summaryTableHtml;
        };
        
        // --- START: New functions for "Grafico" Tab ---
        function renderGraficoTab_full(data) {
            const container = document.getElementById('grafico-container');
            if (!container) return;

            // Initialize layout only once
            if (container.dataset.initialized !== 'true') {
                container.className = ''; // Clear placeholder styles
                container.innerHTML = `
                    <div class="row g-4">
                        <div class="col-lg-3">
                            <div class="card h-100">
                                <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                                    <span>Líneas de Flujo</span>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary" id="check-all-flows">Todas</button>
                                        <button class="btn btn-outline-secondary" id="uncheck-all-flows">Ninguna</button>
                                    </div>
                                </div>
                                <div class="card-body" id="cashflow-checklist-container">
                                    <ul class="list-group list-group-flush cashflow-checklist" id="cashflow-checklist">
                                        <!-- Checkboxes will be injected here -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-9">
                            <div class="card h-100">
                                <div class="card-body d-flex flex-column">
                                    <canvas id="custom-flow-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>`;

                // Add event listeners for the new controls
                document.getElementById('check-all-flows').addEventListener('click', () => toggleAllCheckboxes(true));
                document.getElementById('uncheck-all-flows').addEventListener('click', () => toggleAllCheckboxes(false));
                document.getElementById('cashflow-checklist').addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') {
                        updateCustomFlowChart();
                    }
                });
                
                container.dataset.initialized = 'true';
            }

            // Populate/update the checklist and chart
            populateCashflowChecklist(data.flujo, data.params.currency);
            updateCustomFlowChart(); // This will create or update the chart
        }

        function populateCashflowChecklist(flujo, currency) {
            const checklist = document.getElementById('cashflow-checklist');
            if (!checklist) return;
            checklist.innerHTML = ''; // Clear previous items

            const createItem = (key, data, type) => {
                const total = data.reduce((a, b) => a + b, 0);
                if (Math.abs(total) < 0.01) return ''; // Don't show empty lines
                
                const id = `flow-check-${key.replace(/[^a-zA-Z0-9]/g, '-')}`;
                return `
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="" id="${id}" data-flow-key="${key}" data-flow-type="${type}" checked>
                                <label class="form-check-label" for="${id}">${key}</label>
                            </div>
                            <span class="item-total">${currency} ${formatCurrency(total, 0)}</span>
                        </div>
                    </li>`;
            };
            
            let htmlContent = '<li class="list-group-item bg-light fw-bold">Ingresos</li>';
            for (const key in flujo.ingresos) {
                htmlContent += createItem(key, flujo.ingresos[key], 'ingreso');
            }

            htmlContent += '<li class="list-group-item bg-light fw-bold mt-3">Egresos</li>';
            for (const key in flujo.egresos) {
                htmlContent += createItem(key, flujo.egresos[key], 'egreso');
            }
            
            checklist.innerHTML = htmlContent;
        }

        function toggleAllCheckboxes(check) {
            document.querySelectorAll('#cashflow-checklist .form-check-input').forEach(checkbox => {
                checkbox.checked = check;
            });
            updateCustomFlowChart();
        }

        function updateCustomFlowChart() {
            if (!fullDataCache) return;
            const { flujo, params } = fullDataCache;
            
            const selectedItems = Array.from(document.querySelectorAll('#cashflow-checklist .form-check-input:checked'));
            const numMonths = flujo.meses.length;
            const monthlyFlow = Array(numMonths).fill(0);
            
            selectedItems.forEach(item => {
                const key = item.dataset.flowKey;
                const type = item.dataset.flowType;
                const dataArray = type === 'ingreso' ? flujo.ingresos[key] : flujo.egresos[key];
                
                if (dataArray) {
                    for (let i = 0; i < numMonths; i++) {
                        const value = dataArray[i] || 0;
                        monthlyFlow[i] += (type === 'ingreso' ? value : -value);
                    }
                }
            });

            let accumulator = 0;
            const accumulatedFlow = monthlyFlow.map(value => accumulator += value);

            let lastActiveMonth = 0;
            for (let i = monthlyFlow.length - 1; i >= 0; i--) {
                if (Math.abs(monthlyFlow[i]) > 0.01) {
                    lastActiveMonth = i;
                    break;
                }
            }
            const displayLimit = lastActiveMonth + 2;

            const startDate = new Date(params.fechaInicio + 'T00:00:00');
            const chartLabels = flujo.meses.map((m, i) => {
                const currentDate = new Date(startDate.getFullYear(), startDate.getMonth() + i, 1);
                return `${m} (${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getFullYear()).slice(-2)})`;
            }).slice(0, displayLimit);
            
            const positiveColor = 'rgba(25, 135, 84, 0.5)';
            const negativeColor = 'rgba(220, 53, 69, 0.5)';
            const barColors = monthlyFlow.map(v => v >= 0 ? positiveColor : negativeColor);

            if (!charts.customFlowChart) {
                createCustomFlowChart();
            }

            const chart = charts.customFlowChart;
            chart.data.labels = chartLabels;
            chart.data.datasets[0].data = monthlyFlow.slice(0, displayLimit);
            chart.data.datasets[0].backgroundColor = barColors.slice(0, displayLimit);
            chart.data.datasets[1].data = accumulatedFlow.slice(0, displayLimit);
            chart.options.scales.y.title.text = `Flujo Mensual (${params.currency})`;
            chart.options.scales.y1.title.text = `Flujo Acumulado (${params.currency})`;
            chart.update();
        }
        
        function createCustomFlowChart() {
            const canvas = document.getElementById('custom-flow-chart');
            if (!canvas) return;
            
            const lineColor = 'rgba(25, 135, 84, 1)';
            const fillColor = 'rgba(25, 135, 84, 0.2)';

            charts.customFlowChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Flujo Mensual',
                            data: [],
                            backgroundColor: [], // Set dynamically in update function
                            yAxisID: 'y',
                        },
                        {
                            label: 'Flujo Acumulado',
                            data: [],
                            borderColor: lineColor,
                            backgroundColor: fillColor,
                            type: 'line',
                            yAxisID: 'y1',
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        title: { display: true, text: 'Flujo de Caja Personalizado' },
                        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.parsed.y, 0)}` } }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Mes / Fecha' } },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Flujo Mensual' },
                            ticks: { callback: value => formatCurrency(value, 0) }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Flujo Acumulado' },
                            grid: { drawOnChartArea: false },
                            ticks: { callback: value => formatCurrency(value, 0) }
                        }
                    }
                }
            });
        }
        // --- END: New functions for "Grafico" Tab ---

        function generateCsvString(decimalSeparator = '.') {
            const table = document.querySelector('.cashflow-table');
            if (!table) return '';
            let csvContent = [];
            
            const headerRows = table.querySelectorAll('thead tr');
            headerRows.forEach(headerRow => {
                const headers = Array.from(headerRow.querySelectorAll('th')).map(th => `"${th.textContent.trim()}"`);
                csvContent.push(headers.join(';'));
            });

            const bodyRows = table.querySelectorAll('tbody > tr');
            bodyRows.forEach(row => {
                if(row.children.length <= 1) { 
                    if(row.querySelector('td[colspan]')) { 
                        csvContent.push(`"${row.textContent.trim()}"`);
                    } else {
                        csvContent.push('');
                    }
                    return;
                }
                let rowData = [];
                const cells = row.querySelectorAll('td');
                cells.forEach((cell, index) => {
                    let cellText = cell.textContent.trim();
                    if (index > 0) {
                        const num = parseFormattedNumber(cellText);
                        cellText = isNaN(num) ? '' : num.toFixed(2).replace('.', decimalSeparator);
                    }
                    rowData.push(`"${cellText}"`);
                });
                csvContent.push(rowData.join(';'));
            });

            return csvContent.join('\n');
        }
        function generateSummaryCsvString(decimalSeparator = ',', thousandsSeparator = '.') {
            const table = document.querySelector('#summary-table-card table');
            if (!table) return '';
            let csvContent = [];

            // Explicitly build header row
            const headerCells = table.querySelectorAll('thead th');
            const headerRow = Array.from(headerCells).map(th => `"${th.textContent.trim()}"`).join(';');
            csvContent.push(headerRow);

            // Process body and footer rows
            table.querySelectorAll('tbody tr, tfoot tr').forEach(row => {
                let rowData = [];
                // Handle section headers like "INGRESOS"
                if (row.children.length === 1 && row.querySelector('td[colspan]')) {
                    rowData.push(`"${row.textContent.trim()}"`);
                } else {
                    row.querySelectorAll('td').forEach((cell) => {
                        let cellText = cell.textContent.trim();
                        if (cell.classList.contains('text-end')) {
                            if (cellText.includes('%')) {
                                const num = parseFormattedNumber(cellText.replace('%', '')) / 100;
                                cellText = isNaN(num) ? '' : formatNumberForCsv(num, 3);
                            } else if (cellText !== '-') {
                                const num = parseFormattedNumber(cellText);
                                cellText = isNaN(num) ? '' : formatNumberForCsv(num, 2);
                            }
                        }
                        rowData.push(`"${cellText}"`);
                    });
                }
                csvContent.push(rowData.join(';'));
            });

            return csvContent.join('\n');
        }
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([`\uFEFF${content}`], { type: mimeType });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        function initiateFlowCsvDownloads(projectName) {
            const csvContentComma = generateCsvString(',');
            downloadFile(csvContentComma, `flujo_caja_${projectName}_coma.csv`, 'text/csv;charset=utf-8;');
            const csvContentPeriod = generateCsvString('.');
            downloadFile(csvContentPeriod, `flujo_caja_${projectName}_punto.csv`, 'text/csv;charset=utf-8;');
        }
        function initiateSummaryCsvDownloads(projectName) {
            const csvContentComma = generateSummaryCsvString(',', '.');
            downloadFile(csvContentComma, `resumen_${projectName}_coma.csv`, 'text/csv;charset=utf-8;');
            const csvContentPeriod = generateSummaryCsvString('.', ',');
            downloadFile(csvContentPeriod, `resumen_${projectName}_punto.csv`, 'text/csv;charset=utf-8;');
        }
        function updateDomBeforeSave() { document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], input[type="range"]').forEach(input => { input.setAttribute('value', input.value); }); document.querySelectorAll('select').forEach(select => { select.querySelectorAll('option').forEach(option => { option.removeAttribute('selected'); }); if (select.selectedIndex > -1) { select.options[select.selectedIndex].setAttribute('selected', ''); } }); document.body.setAttribute('data-is-saved', 'true'); }
        
       async function generateAndDownloadAll() {
            const saveBtn = document.getElementById('save-model-btn');
            const originalBtnText = saveBtn.innerHTML;
            
            saveBtn.disabled = true;
            saveBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generando...`;

            try {
                const projectName = document.getElementById('projectName').value;
                const safeProjectName = projectName.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'modelo';
                const now = new Date();
                const dateStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
                const timeStr = String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0') + String(now.getSeconds()).padStart(2, '0');
                const baseFilename = `${safeProjectName}_${dateStr}_${timeStr}`;

                updateDomBeforeSave(); 
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalBtnText;
                const currentHtml = document.documentElement.outerHTML;
                saveBtn.disabled = true;
                saveBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generando...`;
                downloadFile(currentHtml, `${baseFilename}.html`, 'text/html;charset=utf-8;');
                document.body.removeAttribute('data-is-saved');

                initiateFlowCsvDownloads(baseFilename);
                initiateSummaryCsvDownloads(baseFilename);

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const margin = 10;
                const headerHeight = 10;
                const headerY = 7;

                const addPdfHeader = (pdfInstance) => {
                    const pdfWidth = pdfInstance.internal.pageSize.getWidth();
                    pdfInstance.setFillColor('#f8f9fa');
                    pdfInstance.setDrawColor('#dee2e6');
                    pdfInstance.setLineWidth(0.2);
                    pdfInstance.rect(margin, headerY, pdfWidth - margin * 2, headerHeight, 'FD');
                    const now = new Date();
                    const dateStr = now.toLocaleDateString('es-CL');
                    const timeStr = now.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' });
                    const headerText = `Modelador inmobiliario  |  Proyecto: ${projectName}  |  ${dateStr} ${timeStr}`;
                    pdfInstance.setFontSize(9);
                    pdfInstance.setFont(undefined, 'bold');
                    pdfInstance.setTextColor('#212529');
                    const textY = headerY + (headerHeight / 2);
                    pdfInstance.text(headerText, margin + 3, textY, { baseline: 'middle' });
                    pdfInstance.setFont(undefined, 'normal');
                };

                const addContentAsImageToPage = async (pdfInstance, contentElement) => {
                    const canvas = await html2canvas(contentElement, { scale: 2, useCORS: true, allowTaint: true, scrollX: 0, scrollY: -window.scrollY });
                    const pdfWidth = pdfInstance.internal.pageSize.getWidth();
                    const pdfHeight = pdfInstance.internal.pageSize.getHeight();
                    const contentStartY = headerY + headerHeight + 3;
                    const contentWidth = pdfWidth - margin * 2;
                    const contentHeight = pdfHeight - contentStartY - margin;
                    const ratio = canvas.width / canvas.height;
                    let imgWidth = contentWidth;
                    let imgHeight = imgWidth / ratio;
                    if (imgHeight > contentHeight) {
                        imgHeight = contentHeight;
                        imgWidth = imgHeight * ratio;
                    }
                    const x = (pdfWidth - imgWidth) / 2;
                    pdfInstance.addImage(canvas.toDataURL('image/png'), 'PNG', x, contentStartY, imgWidth, imgHeight);
                };
                
                const paramsTabBtn = document.getElementById('params-tab-btn');
                bootstrap.Tab.getOrCreateInstance(paramsTabBtn).show();
                await new Promise(resolve => setTimeout(resolve, 500));
                addPdfHeader(pdf);
                await addContentAsImageToPage(pdf, document.getElementById('params'));
                
                pdf.addPage('p', 'mm', 'a4');
                const evalTabBtn = document.getElementById('eval-tab-btn');
                bootstrap.Tab.getOrCreateInstance(evalTabBtn).show();
                await new Promise(resolve => setTimeout(resolve, 500));
                addPdfHeader(pdf);
                await addContentAsImageToPage(pdf, document.getElementById('charts-container'));

                pdf.addPage('p', 'mm', 'a4');
                const resumenTabBtn = document.getElementById('resumen-tab-btn');
                bootstrap.Tab.getOrCreateInstance(resumenTabBtn).show();
                await new Promise(resolve => setTimeout(resolve, 500));
                addPdfHeader(pdf);
                await addContentAsImageToPage(pdf, document.getElementById('resumen'));
                
                pdf.save(`${baseFilename}_reporte.pdf`);

            } catch (error) {
                console.error("Error durante la generación de archivos:", error);
                alert("Ocurrió un error al generar los archivos. Revise la consola para más detalles.");
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalBtnText;
                bootstrap.Tab.getOrCreateInstance(document.getElementById('params-tab-btn')).show();
            }
        }

        function drawSCurve(kValue) {
            const canvas = document.getElementById('curvaSGraph');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            ctx.clearRect(0, 0, width, height);
            ctx.beginPath();
            ctx.moveTo(0, height);

            if (kValue <= 1) {
                 ctx.lineTo(width, 0);
            } else {
                for (let i = 0; i <= width; i++) {
                    const t = i / width;
                    const y = 1 / (1 + Math.exp(-kValue * (t - 0.5)));
                    ctx.lineTo(i, height - (y * height));
                }
            }
            
            ctx.strokeStyle = '#0d6efd';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        function updateTimelineSlider(inputElement) {
            if (!inputElement || !inputElement.id) return;
            const sliderInfo = timelineSliders[inputElement.id];
            if (sliderInfo) {
                const { slider, handle } = sliderInfo;
                const currentValue = slider.get();
                const newValue = Number(inputElement.value);
                
                if (Array.isArray(currentValue)) {
                    if (currentValue[handle] !== newValue) {
                        const newValues = [...currentValue];
                        newValues[handle] = newValue;
                        slider.set(newValues);
                    }
                } else {
                    if (currentValue !== newValue) {
                        slider.set(newValue);
                    }
                }
            }
        }

        // --- START: Drag and Drop Initialization ---
        function initSortable(tbodyElement) {
            if (tbodyElement) {
                new Sortable(tbodyElement, {
                    animation: 150,
                    handle: '.drag-handle', // Class for the drag handle
                    ghostClass: 'sortable-ghost', // Class for the drop placeholder
                    dragClass: 'sortable-drag', // Class for the item being dragged
                    onEnd: function(evt) {
                        // The DOM is already reordered.
                        // We just need to trigger the full update process.
                        debouncedUpdateAllOutputs();
                    },
                });
            }
        }
        // --- END: Drag and Drop Initialization ---

        paramsTab.addEventListener('input', e => {
            if (e.target.name === 'porcentajeIngreso') {
                updateIngresosEtapasPercentage(e.target);
            }
            if (e.target.id === 'curvaSParam') {
                const kValue = e.target.value;
                document.getElementById('curvaSValue').textContent = kValue;
                drawSCurve(kValue);
                updateTimelineSlider(e.target);
            }
        });
        
        // REEMPLAZADOS POR LA NUEVA LÓGICA DE FORMULAS
        paramsTab.addEventListener('focusin', e => {
            const target = e.target;
            // Lógica para mostrar la fórmula al hacer foco
            if (target.matches('[data-allow-formula="true"]')) {
                const formula = target.dataset.formula;
                if (formula) {
                    target.value = formula;
                }
            }
            // Lógica existente para el porcentaje de ingresos
            if (e.target.name === 'porcentajeIngreso') {
                e.target.dataset.previousValue = e.target.value;
            }
        });

        paramsTab.addEventListener('blur', (e) => { 
            const target = e.target;

            // Lógica para evaluar y almacenar la fórmula al quitar el foco
            if (target.matches('[data-allow-formula="true"]')) {
                const rawValue = target.value;
                const result = evaluateFormula(rawValue);
                
                if (result !== null) { // Era una fórmula válida
                    target.dataset.formula = rawValue; // Guardar la fórmula
                    target.value = String(result).replace('.', ','); // Poner el resultado en el campo para formatearlo
                } else { // No es una fórmula, es un número directo
                    delete target.dataset.formula; // Limpiar cualquier fórmula antigua
                }
            }
            
            // Lógica de formateo existente, que ahora funcionará tanto para números directos
            // como para los resultados de las fórmulas.
            if (target.matches('[data-format="number"]')) { 
                formatInputAsCurrency(target); 
                updateAllFastUI();
            } 
        }, true);


        paramsTab.addEventListener('change', e => {
            if (e.target.matches('select, input')) {
                updateAllFastUI();
            }
            updateTimelineSlider(e.target);
            debouncedUpdateAllOutputs();
        });
        
        document.getElementById('add-unidad').addEventListener('click', () => { addUnidadRow(); debouncedUpdateAllOutputs(); });
        document.getElementById('add-costo').addEventListener('click', () => { addCostoRow(); debouncedUpdateAllOutputs(); });
        document.getElementById('add-deuda').addEventListener('click', () => { addDeudaRow(); debouncedUpdateAllOutputs(); });
        document.getElementById('add-ingreso-etapa').addEventListener('click', () => { addIngresoEtapaRow(); debouncedUpdateAllOutputs(); });

        document.getElementById('precioTerreno').addEventListener('input', updateValorFromPrecio);
        document.getElementById('valorTerrenoM2').addEventListener('input', updatePrecioFromValor);
        document.getElementById('superficieTerreno').addEventListener('input', updatePrecioFromValor);

        currencySelect.addEventListener('change', () => {
             updateAllFastUI();
             debouncedUpdateAllOutputs();
        });
        
        document.getElementById('save-model-btn').addEventListener('click', generateAndDownloadAll);
        
        // --- START: Tab visibility event listeners ---
        const evalTabBtn = document.getElementById('eval-tab-btn');
        evalTabBtn.addEventListener('shown.bs.tab', () => {
            if (charts.flujoPuroChart) charts.flujoPuroChart.resize();
            if (charts.flujoMensualChart) charts.flujoMensualChart.resize();
            if (charts.flujoAcumuladoChart) charts.flujoAcumuladoChart.resize();
            adjustSimHeight();
        });

        const graficoTabBtn = document.getElementById('grafico-tab-btn');
        graficoTabBtn.addEventListener('shown.bs.tab', () => {
            // Ensure the chart is created and rendered correctly when tab becomes visible
            if (!charts.customFlowChart) {
                updateCustomFlowChart();
            } else {
                charts.customFlowChart.resize();
            }
        });
        
        window.addEventListener('resize', debounce(() => {
            adjustSimHeight(); // For eval tab
            if (charts.customFlowChart) charts.customFlowChart.resize(); // For grafico tab
        }, 200));
        // --- END: Tab visibility event listeners ---


        function showCopyFeedback(button, originalContent, originalTitle) {
            button.innerHTML = '<i class="bi bi-check-lg"></i> Copiado';
            button.title = '¡Copiado!';
            button.classList.add('btn-success');
            button.classList.remove('btn-outline-secondary');
            button.disabled = true;
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.title = originalTitle;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-secondary');
                button.disabled = false;
            }, 2000);
        }

        function copyTableToClipboard(button, tableSelector) {
            const table = document.querySelector(tableSelector);
            if (!table) return;

            const originalContent = button.innerHTML;
            const originalTitle = button.title;

            const tsvContent = Array.from(table.querySelectorAll('tr')).map(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                if (cells.length === 1 && cells[0].hasAttribute('colspan')) {
                    return `"${cells[0].textContent.trim().replace(/"/g, '""')}"`;
                }
                if (cells.length > 1 && cells.every(c => c.textContent.trim() === '')) {
                    return null;
                }
                return cells.map(cell => `"${cell.textContent.trim().replace(/"/g, '""')}"`).join('\t');
            }).filter(row => row !== null).join('\n');

            navigator.clipboard.writeText(tsvContent).then(() => {
                showCopyFeedback(button, originalContent, originalTitle);
            }).catch(err => {
                console.error('Error al copiar la tabla: ', err);
                alert('No se pudo copiar la tabla.');
            });
        }

        function copyParamsToClipboard(button) {
            const originalContent = button.innerHTML;
            const originalTitle = button.title;
            const tsvData = [];
            const addRow = (label, value = '') => {
                const cleanLabel = String(label).replace(/\t|\n|\r/g, ' ').trim();
                const cleanValue = String(value).replace(/\t|\n|\r/g, ' ').trim();
                tsvData.push(`${cleanLabel}\t${cleanValue}`);
            };
            const addSection = (title) => {
                if (tsvData.length > 0) tsvData.push('');
                tsvData.push(title);
            };
            const getVal = (id) => document.getElementById(id)?.value || '';
            const getTxt = (id) => document.getElementById(id)?.textContent || '';

            addSection('Configuración General del Proyecto');
            addRow('Nombre del Proyecto', getVal('projectName'));
            addRow('Moneda', getVal('currency'));
            addRow('Tasa Descuento Anual (%)', getVal('discountRate'));
            addRow('Tasa Impuesto (%)', getVal('taxRate'));
            addRow('IVA (%)', getVal('iva'));
            addRow('Fecha inicio', getVal('fechaInicio'));
            addRow('Mes inicio venta', getVal('mesInicioVenta'));

            addSection('Crédito de construcción');
            addRow('Monto', getVal('montoFinanciamiento'));
            addRow('Tasa interés anual (%)', getVal('tasaInteresAnual'));
            addRow('Cuota Alzamiento (% ing.)', getVal('cuotaAlzamiento'));

            processTable('deuda-tbody', 'Deuda');
            processTable('unidades-tbody', 'Unidades a Vender (Ingresos)');
            processTable('ingresos-etapas-tbody', 'Ingresos por Etapas');
            
            addSection('Comisión de ventas');
            addRow('% Venta (Cierre)', getVal('comisionCierre'));
            addRow('% Venta (Escritura)', getVal('comisionEscritura'));
            addRow('% Venta (Recup.)', getVal('comisionRecuperacion'));
            addRow('% Total Comisión', getTxt('totalPorcentajeComision'));

            addSection('Terreno');
            addRow('Precio Total', getVal('precioTerreno'));
            addRow('Superficie (m²)', getVal('superficieTerreno'));
            addRow('Valor /m²', getVal('valorTerrenoM2'));
            addRow('Mes Compra Terreno', getVal('mesCompraTerreno'));

            addSection('Construcción');
            addRow('Sobre 0 (m²)', getVal('superficieLosaSobre'));
            addRow('Bajo 0 (m²)', getVal('superficieLosaBajo'));
            addRow('Urbanización (m²)', getVal('superficieUrbanizacion'));
            addRow('Costo sobre 0 /m²', getVal('costoM2Sobre'));
            addRow('Costo bajo 0 /m²', getVal('costoM2Bajo'));
            addRow('Costo urbanización /m²', getVal('costoM2Urbanizacion'));
            addRow('Afecto IVA', getVal('ivaAfectoConstruccion') === 'si' ? 'Sí' : 'No');
            addRow('% Anticipo', getVal('porcAnticipo'));
            addRow('% Retención', getVal('porcRetencion'));
            addRow('Mes Inicio', getVal('mesInicioConstruccion'));
            addRow('Mes Término', getVal('mesTerminoConstruccion'));
            addRow('Curva S', getVal('curvaSParam'));

            processTable('costos-tbody', 'Costos');

            const tsvContent = tsvData.join('\n');

            navigator.clipboard.writeText(tsvContent).then(() => {
                showCopyFeedback(button, originalContent, originalTitle);
            }).catch(err => {
                console.error('Error al copiar los parámetros: ', err);
                alert('No se pudo copiar la tabla de parámetros.');
            });
        }

        function copySummaryToClipboard(button) {
            const originalContent = button.innerHTML;
            const originalTitle = button.title;
            const tsvData = [];
            const addRow = (label, value = '') => {
                const cleanLabel = String(label).replace(/\t|\n|\r/g, ' ').trim();
                const cleanValue = String(value).replace(/\t|\n|\r/g, ' ').trim();
                tsvData.push(`${cleanLabel}\t${cleanValue}`);
            };
            const addSection = (title) => {
                if (tsvData.length > 0) tsvData.push('');
                tsvData.push(title);
            };

            addSection('Indicadores Principales (Encabezado)');
            document.querySelectorAll('#header-kpi-container .header-kpi').forEach(kpi => {
                const label = kpi.querySelector('.header-kpi-label').textContent;
                const value = kpi.querySelector('.header-kpi-value').textContent;
                addRow(label, value);
            });

            addSection('Tabla de Ingresos y Egresos (Resumen)');
            const table = document.querySelector('#summary-table-card .table');
            if (table) {
                const tableTsv = Array.from(table.querySelectorAll('tr')).map(row => {
                    const cells = Array.from(row.querySelectorAll('th, td'));
                    if (cells.length === 1 && cells[0].hasAttribute('colspan')) {
                        return `"${cells[0].textContent.trim().replace(/"/g, '""')}"`;
                    }
                    if (cells.length > 1 && cells.every(c => c.textContent.trim() === '')) {
                        return null;
                    }
                    return cells.map(cell => `"${cell.textContent.trim().replace(/"/g, '""')}"`).join('\t');
                }).filter(row => row !== null).join('\n');
                tsvData.push(tableTsv);
            }

            const tsvContent = tsvData.join('\n');
            navigator.clipboard.writeText(tsvContent).then(() => {
                showCopyFeedback(button, originalContent, originalTitle);
            }).catch(err => {
                console.error('Error al copiar el resumen: ', err);
                alert('No se pudo copiar el resumen.');
            });
        }

        document.getElementById('copy-active-tab-btn').addEventListener('click', function(e) {
            const copyBtn = e.currentTarget;
            const activeTabContent = document.querySelector('.tab-pane.fade.show.active');
            if (!activeTabContent) return;
            const activeTabId = activeTabContent.id;
            
            switch (activeTabId) {
                case 'params':
                    copyParamsToClipboard(copyBtn);
                    break;
                case 'grafico':
                case 'eval':
                    // This case is handled by the tab change event listener hiding the button
                    break;
                case 'flow':
                    copyTableToClipboard(copyBtn, '#flujo-caja-container .cashflow-table');
                    break;
                case 'resumen':
                    copySummaryToClipboard(copyBtn);
                    break;
            }
        });

        document.querySelectorAll('#myTab .nav-link').forEach(tab => {
            tab.addEventListener('shown.bs.tab', event => {
                const copyBtn = document.getElementById('copy-active-tab-btn');
                const targetTabId = event.target.getAttribute('data-bs-target');

                copyBtn.style.display = 'block';
                switch (targetTabId) {
                    case '#params':
                        copyBtn.title = 'Copiar todos los parámetros de entrada al portapapeles';
                        break;
                    case '#grafico':
                    case '#eval':
                        copyBtn.style.display = 'none';
                        break;
                    case '#flow':
                        copyBtn.title = 'Copiar tabla de Flujo de Caja al portapapeles';
                        break;
                    case '#resumen':
                        copyBtn.title = 'Copiar KPIs y tabla de resumen al portapapeles';
                        break;
                }
            });
        });
        
        // --- START: Undo/Redo Event Listeners ---
        document.getElementById('undo-btn').addEventListener('click', doUndo);
        document.getElementById('redo-btn').addEventListener('click', doRedo);

        document.addEventListener('keydown', (e) => {
            // Take control of Ctrl+Z and Ctrl+Y everywhere
            if (e.ctrlKey && !e.shiftKey && e.key.toLowerCase() === 'z') {
                e.preventDefault();
                document.getElementById('undo-btn').click();
            }
            if ((e.ctrlKey && e.key.toLowerCase() === 'y') || (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'z')) {
                e.preventDefault();
                document.getElementById('redo-btn').click();
            }
        });
        // --- END: Undo/Redo Event Listeners ---

        // --- INICIALIZACIÓN DE LA PÁGINA ---

        if (document.body.getAttribute('data-is-saved') !== 'true') {
            document.getElementById('fechaInicio').valueAsDate = new Date();
            
            addUnidadRow({tipo: 'departamento', nombre: '2D1B', cantidad: 100, superficie: '50,0', precio: '2500' });
            addUnidadRow({tipo: 'casa', nombre: '3D2B', cantidad: 50, superficie: '55,0', precio: '3500' });
            addUnidadRow({tipo: 'bodega', nombre: 'Bodsubt', cantidad: 120, superficie: '5,0', precio: '120' });
            addUnidadRow({tipo: 'est_sup', nombre: 'Techado', cantidad: 50, superficie: '12,5', precio: '180' });
            addUnidadRow({tipo: 'est_sub', nombre: 'Tándem', cantidad: 100, superficie: '12,5', precio: '300' });
            addUnidadRow({tipo: 'otro', nombre: 'Local Comercial', cantidad: 3, superficie: '40,0', precio: '2500' });

            addIngresoEtapaRow({ porcentaje: '3,00', descripcion: "Anticipos", inicio: 10, fin: 35 });
            addIngresoEtapaRow({ porcentaje: '33,00', descripcion: "Etapa 1", inicio: 24, fin: 30 });
            addIngresoEtapaRow({ porcentaje: '49,00', descripcion: "Etapa 2", inicio: 28, fin: 35 });
            addIngresoEtapaRow({ porcentaje: '15,00', descripcion: "Reposiciones", inicio: 24, fin: 35 });

            addCostoRow({ item: 'Administración', tipo: 'pct_venta', valor: '4,00', afectoIVA: 'si', inicio: 1, fin: 40 });
            addCostoRow({ item: 'Estructuración', tipo: 'pct_venta', valor: '1,50', afectoIVA: 'si', inicio: 6, fin: 6 });
            addCostoRow({ item: 'Publicidad', tipo: 'pct_venta', valor: '0,80', afectoIVA: 'si', inicio: 9, fin: 30 });
            addCostoRow({ item: 'Proyectos previos', tipo: 'unidad', valor: '80,0', afectoIVA: 'si', inicio: 1, fin: 14 });
            addCostoRow({ item: 'Proyectos y permisos obra', tipo: 'unidad', valor: '40,0', afectoIVA: 'si', inicio: 12, fin: 30 });
            addCostoRow({ item: 'Empalmes', tipo: 'gl', valor: '3000', afectoIVA: 'si', inicio: 18, fin: 22 });
            addCostoRow({ item: 'Demolición', tipo: 'gl', valor: '1500', afectoIVA: 'no', inicio: 4, fin: 5 });

            addDeudaRow({ item: 'Préstamo enlace', monto: '2000', tasa: '6,00', inicioGiros: 1, finGiros: 3, inicioAbonos: 22, finAbonos: 25, formaPago: 'Fija' });
        }
        
        // Initialize Drag and Drop for the specified tables
        initSortable(unidadesTbody);
        initSortable(ingresosEtapasTbody);
        initSortable(costosTbody);
        
        document.querySelectorAll('[data-format="number"]').forEach(input => formatInputAsCurrency(input));
        
        drawSCurve(document.getElementById('curvaSParam').value);
        updateValorFromPrecio();
        updateAllFastUI();
        updateAllOutputs(); // This also creates the first state for the undo stack

        function handleExportJSON() {
            try {
                const params = getParams();
                const jsonContent = JSON.stringify(params, null, 2);
                const projectName = params.projectName.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'modelo';
                downloadFile(jsonContent, `parametros_${projectName}.json`, 'application/json;charset=utf-8;');

            } catch (error) {
                console.error("Error al exportar los parámetros a JSON:", error);
                alert("No se pudieron exportar los parámetros. Revise la consola.");
            }
        }
        
        function handleImportJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    isLoadingState = true; // Prevent history push during load
                    const jsonContent = e.target.result;
                    const params = JSON.parse(jsonContent);
                    
                    if (!params || typeof params.unidades === 'undefined' || typeof params.projectName === 'undefined') {
                        throw new Error("El archivo JSON no contiene la estructura de parámetros esperada.");
                    }
                    
                    // On successful import, reset the history
                    undoStack = [];
                    redoStack = [];

                    loadParamsFromJSON(params);
                    alert("Parámetros importados con éxito.");

                } catch (error) {
                    console.error("Error al importar el archivo JSON:", error);
                    alert("El archivo JSON no tiene el formato correcto o está dañado.");
                } finally {
                    isLoadingState = false;
                    // The updateAllOutputs within loadParamsFromJSON will now create the new initial state
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        function loadParamsFromJSON(params) {
            unidadesTbody.innerHTML = '';
            costosTbody.innerHTML = '';
            deudaTbody.innerHTML = '';
            ingresosEtapasTbody.innerHTML = '';
            unidadCounter = costoCounter = ingresoEtapaCounter = deudaCounter = 0;
            
            const setFieldValue = (id, value) => {
                const el = document.getElementById(id);
                if (el) {
                    if (el.dataset.format === 'number' && typeof value === 'number') {
                        el.value = String(value).replace('.', ',');
                    } else {
                        el.value = value;
                    }
                }
            };
            
            setFieldValue('projectName', params.projectName);
            setFieldValue('currency', params.currency);
            setFieldValue('discountRate', params.discountRate * 100);
            setFieldValue('taxRate', params.taxRate * 100);
            setFieldValue('iva', params.iva * 100);
            setFieldValue('fechaInicio', params.fechaInicio);
            if(params.mesInicioVenta) setFieldValue('mesInicioVenta', params.mesInicioVenta);
            setFieldValue('precioTerreno', params.terreno.precio);
            setFieldValue('superficieTerreno', params.terreno.superficie);
            setFieldValue('mesCompraTerreno', params.mesCompraTerreno);
            setFieldValue('superficieLosaSobre', params.construccion.superficieLosaSobre);
            setFieldValue('superficieLosaBajo', params.construccion.superficieLosaBajo);
            setFieldValue('superficieUrbanizacion', params.construccion.superficieUrbanizacion);
            setFieldValue('costoM2Sobre', params.construccion.costoM2Sobre);
            setFieldValue('costoM2Bajo', params.construccion.costoM2Bajo);
            setFieldValue('costoM2Urbanizacion', params.construccion.costoM2Urbanizacion);
            setFieldValue('ivaAfectoConstruccion', (params.construccion.afectoIVA === false) ? 'no' : 'si');
            setFieldValue('porcAnticipo', params.construccion.anticipo * 100);
            setFieldValue('porcRetencion', params.construccion.retencion * 100);
            setFieldValue('mesInicioConstruccion', params.mesInicioConstruccion);
            setFieldValue('mesTerminoConstruccion', params.mesTerminoConstruccion);
            setFieldValue('curvaSParam', params.construccion.curvaSParam);
            setFieldValue('montoFinanciamiento', params.financiamiento.monto);
            setFieldValue('tasaInteresAnual', params.financiamiento.tasa * 100);
            setFieldValue('cuotaAlzamiento', params.financiamiento.cuotaAlzamiento * 100);
            setFieldValue('comisionCierre', params.comisionVentas.cierre * 100);
            setFieldValue('comisionEscritura', params.comisionVentas.escritura * 100);
            setFieldValue('comisionRecuperacion', params.comisionVentas.recuperacion * 100);

            const toCommaString = (obj, key) => {
                if (obj && typeof obj[key] === 'number') {
                    obj[key] = String(obj[key]).replace('.', ',');
                }
            };
            
            params.unidades.forEach(d => {
                toCommaString(d, 'precio'); toCommaString(d, 'superficie'); toCommaString(d, 'velocidad');
                addUnidadRow(d);
            });
            params.ingresosEtapas.forEach(d => {
                const porcentajeConComa = String(d.porcentaje * 100).replace('.', ',');
                addIngresoEtapaRow({ ...d, porcentaje: porcentajeConComa });
            });
            
            if (params.costos) {
                 params.costos.forEach(d => {
                    const dataToLoad = { ...d };
                    if (d.tipo === 'pct_venta' || d.tipo === 'pct_const') {
                        dataToLoad.valor = String(d.valor * 100).replace('.', ',');
                    } else { toCommaString(dataToLoad, 'valor'); }
                    addCostoRow(dataToLoad);
                });
            }

            if (params.deudas) {
                params.deudas.forEach(d => {
                    const dataToLoad = { ...d, monto: String(d.monto), tasa: String(d.tasa * 100).replace('.', ',') };
                    addDeudaRow(dataToLoad);
                });
            }

            document.querySelectorAll('[data-format="number"]').forEach(formatInputAsCurrency);
            updateAllFastUI();
            updateAllOutputs();
        }

        document.getElementById('export-model-btn').addEventListener('click', handleExportJSON);
        document.getElementById('import-file-input').addEventListener('change', handleImportJSON);
    });
    </script>
</body>
</html>